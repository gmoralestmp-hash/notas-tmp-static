<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Notas TMP Regenerative</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#00b5ad">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="./icons/icon-512.png">
  <meta name="apple-mobile-web-app-title" content="Notas TMP">
  <style>
    :root{--c:#00b5ad}
    body { font-family: system-ui, sans-serif; background:#f8fafc; color:#222; margin:0; padding:16px; }
    h1 { text-align:center; color:var(--c); }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1); padding:16px; max-width:1000px; margin:20px auto; }
    .row { display:flex; align-items:center; gap:8px; }
    .between { justify-content:space-between; }
    .actions { text-align:center; margin-bottom:16px; }
    button { background:var(--c); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button.secondary { background:#e6f7f6; color:#0d6662; }
    button.danger { background:#e55252; }
    button:hover { opacity:.95 }
    input, textarea, select { border:1px solid #cfd6de; border-radius:8px; padding:8px 10px; width:100%; font-size:14px; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3 { display:grid; grid-template-columns:2fr 1fr 1fr; gap:8px; }
    .line { border-top:1px solid #e5e7eb; margin:12px 0; }
    .total { font-weight:700; }
    .right { text-align:right; }
    .admin { display:none; padding:12px; border:1px dashed #cfd6de; border-radius:10px; background:#fafcff; margin-top:8px; }
    .admin h4{ margin:0 0 8px 0; }
    .admin-list .row{ justify-content:space-between; padding:6px 0; border-bottom:1px solid #eef2f6; }
    .admin-list .row:last-child{ border-bottom:none; }
    @media print { #acciones, .no-print, .admin { display:none!important } body{ background:#fff } .card{ box-shadow:none } }
  </style>
</head>
<body>

  <h1>Notas de Remisi√≥n TMP Regenerative</h1>

  <div id="acciones" class="actions">
    <button onclick="guardarHistorial()">üíæ Guardar / Nuevo folio</button>
    <button onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
  </div>

  <div class="card">
    <div class="row between">
      <div>
        <h3 style="margin:0">TMP Regenerative</h3>
        <p style="margin:0">Chihuahua, M√©xico</p>
      </div>
      <div style="text-align:right">
        <img src="./icons/tmp-logo.png" alt="TMP Regenerative" style="height:72px;object-fit:contain">
        <p style="margin:6px 0 0 0;font-weight:700">Nota de remisi√≥n</p>
        <p id="folio" style="margin:0;font-size:14px">TMP-0001</p>
        <p id="fecha" style="margin:0;font-size:13px"></p>
      </div>
    </div>

    <div class="line"></div>

    <!-- CLIENTE -->
    <h3 style="margin:6px 0">Cliente</h3>
    <div class="grid2">
      <div>
        <label>Seleccionar cliente guardado</label>
        <select id="selCliente" onchange="aplicarClienteSeleccionado()">
          <option value="">‚Äî Elegir cliente ‚Äî</option>
        </select>
      </div>
      <div class="row" style="align-items:end">
        <div style="flex:1">
          <label>&nbsp;</label>
          <div class="row">
            <button class="secondary" style="flex:1" onclick="guardarClienteActual()">üìá Guardar cliente actual</button>
            <button class="secondary" style="flex:1" onclick="toggleAdmin('adminClientes')">‚öôÔ∏è Administrar</button>
          </div>
        </div>
      </div>
      <div>
        <label>Nombre</label>
        <input id="cliente" placeholder="Nombre del cliente">
      </div>
      <div>
        <label>Direcci√≥n</label>
        <input id="direccion" placeholder="Direcci√≥n del cliente">
      </div>
    </div>

    <!-- Admin clientes -->
    <div id="adminClientes" class="admin no-print">
      <h4>Clientes guardados</h4>
      <div id="listaClientes" class="admin-list"></div>
      <div class="row between" style="margin-top:8px">
        <div class="row" style="gap:6px">
          <button class="secondary" onclick="exportarCatalogo('clientes')">‚¨áÔ∏è Exportar</button>
          <input type="file" id="importClientesFile" accept="application/json" style="display:none" onchange="importarCatalogo(event,'clientes')">
          <button class="secondary" onclick="document.getElementById('importClientesFile').click()">‚¨ÜÔ∏è Importar</button>
        </div>
        <button class="danger" onclick="borrarTodosClientes()">üóëÔ∏è Borrar todos</button>
      </div>
    </div>

    <div class="line"></div>

    <!-- CONCEPTOS -->
    <div class="row between">
      <h3 style="margin:6px 0">Conceptos</h3>
      <div class="row">
        <button class="secondary no-print" onclick="toggleAdmin('adminProductos')">‚öôÔ∏è Administrar productos</button>
        <button class="secondary no-print" onclick="addItem()">‚ûï Agregar concepto</button>
      </div>
    </div>

    <div id="items"></div>

    <!-- Admin productos -->
    <div id="adminProductos" class="admin no-print">
      <h4>Productos guardados</h4>
      <div id="listaProductos" class="admin-list"></div>
      <div class="row between" style="margin-top:8px">
        <div class="row" style="gap:6px">
          <button class="secondary" onclick="exportarCatalogo('productos')">‚¨áÔ∏è Exportar</button>
          <input type="file" id="importProductosFile" accept="application/json" style="display:none" onchange="importarCatalogo(event,'productos')">
          <button class="secondary" onclick="document.getElementById('importProductosFile').click()">‚¨ÜÔ∏è Importar</button>
        </div>
        <button class="danger" onclick="borrarTodosProductos()">üóëÔ∏è Borrar todos</button>
      </div>
    </div>

    <div class="line"></div>

    <!-- TOTALES -->
    <div style="max-width:420px;margin-left:auto;display:grid;gap:8px">
      <div class="row between">
        <span>Subtotal (IVA incluido)</span>
        <b id="subtotal">$0</b>
      </div>
      <div class="row between" style="align-items:center">
        <div>Descuento</div>
        <div class="row" style="align-items:center">
          <input style="width:90px;text-align:right" type="number" min="0" max="100" step="0.5" id="descuento" value="0" oninput="calc()">
          <div style="width:24px;text-align:center">%</div>
          <div style="width:130px;text-align:right">-<span id="descMonto">$0</span></div>
        </div>
      </div>
      <div class="row between total">
        <span>Total</span>
        <b id="total">$0</b>
      </div>
    </div>

    <div class="line"></div>

    <textarea id="notas" placeholder="Notas adicionales" rows="3" style="width:100%"></textarea>
  </div>

  <script>
    // ===== Utilidades =====
    const mxn = new Intl.NumberFormat("es-MX", { style:"currency", currency:"MXN" });
    const $ = id => document.getElementById(id);
    const download = (name, content) => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content],{type:'application/json'}));
      a.download = name; a.click();
    };

    // ===== Claves de almacenamiento =====
    const LS = {
      FOLIO: "tmp_folio",
      HIST: "tmp_historial",
      CLIENTES: "tmp_clientes",
      PRODUCTOS: "tmp_productos"
    };

    // ===== Estado =====
    const state = {
      nota: { items: [] },
      clientes: [],
      productos: []
    };

    // ===== Carga inicial =====
    document.addEventListener("DOMContentLoaded", () => {
      $('fecha').textContent = new Date().toLocaleDateString("es-MX");
      const folioNum = Number(localStorage.getItem(LS.FOLIO) || 1);
      $('folio').textContent = "TMP-" + String(folioNum).padStart(4,"0");

      cargarCatalogos();
      addItem(); // primer rengl√≥n
      calc();
    });

    // ===== Mostrar/Ocultar secciones admin =====
    function toggleAdmin(id){
      const el = $(id);
      el.style.display = (el.style.display === 'block') ? 'none' : 'block';
      if(id === 'adminClientes') renderAdminClientes();
      if(id === 'adminProductos') renderAdminProductos();
    }

    // ===== Cat√°logos =====
    function cargarCatalogos(){
      try { state.clientes = JSON.parse(localStorage.getItem(LS.CLIENTES) || "[]"); } catch { state.clientes = []; }
      try { state.productos = JSON.parse(localStorage.getItem(LS.PRODUCTOS) || "[]"); } catch { state.productos = []; }
      // poblar select de clientes
      const sel = $('selCliente');
      sel.innerHTML = '<option value="">‚Äî Elegir cliente ‚Äî</option>' + state.clientes.map((c,i)=>`<option value="${i}">${c.nombre}</option>`).join('');
    }
    function guardarCatalogos(){
      localStorage.setItem(LS.CLIENTES, JSON.stringify(state.clientes));
      localStorage.setItem(LS.PRODUCTOS, JSON.stringify(state.productos));
      cargarCatalogos();
      // refrescar selects de productos en cada √≠tem
      document.querySelectorAll('.selProducto').forEach((el,idx)=>poblarSelectProducto(el, $('item-desc-'+idx), $('item-precio-'+idx)));
    }

    // ===== Clientes =====
    function aplicarClienteSeleccionado(){
      const idx = $('selCliente').value;
      if (idx === "") return;
      const c = state.clientes[Number(idx)];
      $('cliente').value = c?.nombre || '';
      $('direccion').value = c?.direccion || '';
    }
    function guardarClienteActual(){
      const nombre = ($('cliente').value || '').trim();
      const direccion = ($('direccion').value || '').trim();
      if(!nombre){ alert("Escribe el nombre del cliente para guardarlo."); return; }
      const exists = state.clientes.some(c => c.nombre.toLowerCase() === nombre.toLowerCase());
      if(!exists) state.clientes.unshift({ nombre, direccion });
      else state.clientes = state.clientes.map(c=>c.nombre.toLowerCase()===nombre.toLowerCase()?({...c,direccion}):c);
      guardarCatalogos();
      alert("Cliente guardado ‚úÖ");
    }
    function renderAdminClientes(){
      const cont = $('listaClientes'); cont.innerHTML = '';
      if(state.clientes.length===0){ cont.innerHTML = '<div class="muted">No hay clientes guardados.</div>'; return; }
      state.clientes.forEach((c,i)=>{
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `<div><b>${c.nombre}</b><br><small>${c.direccion||'‚Äî'}</small></div>
                         <button class="danger" onclick="eliminarCliente(${i})">Eliminar</button>`;
        cont.appendChild(row);
      });
    }
    function eliminarCliente(i){
      state.clientes.splice(i,1);
      guardarCatalogos();
      renderAdminClientes();
    }
    function borrarTodosClientes(){
      if(!confirm("¬øBorrar todos los clientes guardados?")) return;
      state.clientes = [];
      guardarCatalogos();
      renderAdminClientes();
    }

    // ===== Productos =====
    function poblarSelectProducto(selectEl, descEl, precioEl){
      selectEl.innerHTML = '<option value="">‚Äî Producto ‚Äî</option>' + state.productos.map((p,i)=>`<option value="${i}">${p.nombre} (${mxn.format(p.precio)})</option>`).join('');
      selectEl.onchange = () => {
        const idx = selectEl.value;
        if(idx === "") return;
        const p = state.productos[Number(idx)];
        descEl.value = p.nombre;
        precioEl.value = p.precio;
        descEl.dispatchEvent(new Event('input'));
        precioEl.dispatchEvent(new Event('input'));
      };
    }
    function guardarProductoDesdeFila(idx){
      const desc = $('item-desc-'+idx).value.trim();
      const precio = Number($('item-precio-'+idx).value || 0);
      if(!desc){ alert("Escribe la descripci√≥n del producto para guardarlo."); return; }
      const exists = state.productos.some(p => p.nombre.toLowerCase() === desc.toLowerCase());
      if(!exists) state.productos.unshift({ nombre: desc, precio });
      else state.productos = state.productos.map(p => p.nombre.toLowerCase() === desc.toLowerCase() ? ({ ...p, precio }) : p);
      guardarCatalogos();
      alert("Producto guardado ‚úÖ");
    }
    function renderAdminProductos(){
      const cont = $('listaProductos'); cont.innerHTML = '';
      if(state.productos.length===0){ cont.innerHTML = '<div class="muted">No hay productos guardados.</div>'; return; }
      state.productos.forEach((p,i)=>{
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `<div><b>${p.nombre}</b><br><small>${mxn.format(p.precio)}</small></div>
                         <button class="danger" onclick="eliminarProducto(${i})">Eliminar</button>`;
        cont.appendChild(row);
      });
    }
    function eliminarProducto(i){
      state.productos.splice(i,1);
      guardarCatalogos();
      renderAdminProductos();
    }
    function borrarTodosProductos(){
      if(!confirm("¬øBorrar todos los productos guardados?")) return;
      state.productos = [];
      guardarCatalogos();
      renderAdminProductos();
    }

    // ===== Exportar / Importar cat√°logos (JSON) =====
    function exportarCatalogo(tipo){
      const data = tipo==='clientes' ? state.clientes : state.productos;
      download(`${tipo}-tmp.json`, JSON.stringify(data, null, 2));
    }
    function importarCatalogo(e,tipo){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const arr = JSON.parse(reader.result||"[]");
          if(!Array.isArray(arr)) throw new Error("Formato inv√°lido");
          if(tipo==='clientes') state.clientes = arr;
          else state.productos = arr;
          guardarCatalogos();
          if(tipo==='clientes') renderAdminClientes(); else renderAdminProductos();
          alert("Cat√°logo importado ‚úÖ");
        }catch(err){ alert("No se pudo importar: " + err.message); }
        e.target.value = '';
      };
      reader.readAsText(file);
    }

    // ===== √çtems =====
    function addItem(){
      const idx = state.nota.items.length;
      state.nota.items.push({ id: Date.now()+idx, descripcion:'', cantidad:1, precio:0 });

      const row = document.createElement('div');
      row.className = 'card';
      row.style.padding = '10px';
      row.style.margin = '8px 0';

      row.innerHTML = `
        <div class="grid3">
          <div>
            <label>Descripci√≥n</label>
            <input id="item-desc-${idx}" placeholder="Descripci√≥n">
          </div>
          <div>
            <label>Cantidad</label>
            <input type="number" id="item-cant-${idx}" value="1" min="0">
          </div>
          <div>
            <label>Precio</label>
            <input type="number" id="item-precio-${idx}" value="0" min="0">
          </div>
        </div>
        <div class="row between" style="margin-top:8px">
          <div class="row" style="flex:1">
            <select class="selProducto" id="item-sel-${idx}" style="flex:1"></select>
            <button class="secondary no-print" style="white-space:nowrap" onclick="guardarProductoDesdeFila(${idx})">üíæ Guardar como producto</button>
          </div>
          <div class="row" style="gap:6px">
            <div class="right" style="min-width:140px"><b id="item-total-${idx}">$0</b></div>
            <button class="no-print" onclick="removeItem(${idx})">üóëÔ∏è</button>
          </div>
        </div>
      `;

      $('items').appendChild(row);

      const descEl = $('item-desc-'+idx);
      const cantEl = $('item-cant-'+idx);
      const precioEl = $('item-precio-'+idx);
      const totalEl = $('item-total-'+idx);
      const selEl = $('item-sel-'+idx);

      descEl.oninput = () => { state.nota.items[idx].descripcion = descEl.value; calcFila(idx,totalEl,cantEl,precioEl); };
      cantEl.oninput = () => { state.nota.items[idx].cantidad = Number(cantEl.value||0); calcFila(idx,totalEl,cantEl,precioEl); };
      precioEl.oninput = () => { state.nota.items[idx].precio = Number(precioEl.value||0); calcFila(idx,totalEl,cantEl,precioEl); };

      poblarSelectProducto(selEl, descEl, precioEl);
      calc();
    }
    function calcFila(idx,totalEl,cantEl,precioEl){
      const cant = Number(cantEl.value||0);
      const precio = Number(precioEl.value||0);
      totalEl.textContent = mxn.format(cant * precio);
      calc();
    }
    function removeItem(idx){
      state.nota.items.splice(idx,1);
      $('items').innerHTML = '';
      const itemsPrev = [...state.nota.items];
      state.nota.items = [];
      itemsPrev.forEach(()=>addItem());
      itemsPrev.forEach((it,i)=>{
        $('item-desc-'+i).value = it.descripcion;
        $('item-cant-'+i).value = it.cantidad;
        $('item-precio-'+i).value = it.precio;
        $('item-desc-'+i).dispatchEvent(new Event('input'));
        $('item-cant-'+i).dispatchEvent(new Event('input'));
        $('item-precio-'+i).dispatchEvent(new Event('input'));
      });
      calc();
    }

    // ===== Totales =====
    function calc(){
      const subtotal = (state.nota.items||[]).reduce((a,it)=>a+(Number(it.cantidad||0)*Number(it.precio||0)),0);
      const desc = subtotal * (Number($('descuento').value||0)/100);
      const total = Math.max(0, subtotal - desc);
      $('subtotal').textContent = mxn.format(subtotal);
      $('descMonto').textContent = mxn.format(desc);
      $('total').textContent = mxn.format(total);
    }

    // ===== Historial y folios =====
    function guardarHistorial(){
      const folioActual = $('folio').textContent;
      const cliente = $('cliente').value || "‚Äî";
      const total = $('total').textContent;
      const hist = JSON.parse(localStorage.getItem(LS.HIST) || "[]");
      hist.unshift({ folio: folioActual, cliente, total, fecha: new Date().toLocaleDateString("es-MX") });
      localStorage.setItem(LS.HIST, JSON.stringify(hist));
      let folioNum = Number(localStorage.getItem(LS.FOLIO) || 1);
      folioNum++;
      localStorage.setItem(LS.FOLIO, folioNum);
      alert("Nota guardada ‚úÖ Nuevo folio: TMP-" + String(folioNum).padStart(4,"0"));
      location.reload();
    }
  </script>

</body>
</html>

