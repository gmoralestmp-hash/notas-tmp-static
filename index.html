<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Notas de Remisi√≥n TMP Regenerative</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#00b5ad">
<link rel="icon" href="icons/icon-192.png">
<style>
  :root{--c:#00b5ad}
  body{font-family:system-ui,sans-serif;background:#f8fafc;color:#222;margin:0}
  h1{text-align:center;color:var(--c);margin:16px 0}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:16px;max-width:1000px;margin:20px auto}
  .row{display:flex;gap:8px;align-items:center}
  .between{justify-content:space-between}
  input,select,textarea{width:100%;padding:8px;border:1px solid #cfd6de;border-radius:8px;font-size:14px}
  button{background:var(--c);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
  button.secondary{background:#e6f7f6;color:#0d6662}
  button.danger{background:#e74c3c}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px}
  .line{border-top:1px solid #e5e7eb;margin:12px 0}
  .right{text-align:right}
  .muted{font-size:12px;color:#6b7785}
  #msg{display:none;margin-top:8px;border-radius:8px;padding:8px}
  .ok{background:#e7fbf9;color:#0e7a72;border:1px solid #b7efea}
  .err{background:#fdecec;color:#8a1e1e;border:1px solid #f5bcbc}
  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px auto;max-width:1000px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eef2f6;text-align:left;font-size:14px}
  th{background:#f3f6f9}
  .paybox{border:1px dashed #9adeda;background:#f6fffe;border-radius:10px;padding:10px}
  @media print{ .no-print{display:none!important} .card{box-shadow:none} }
</style>
</head>
<body>
  <h1>Notas de Remisi√≥n TMP Regenerative</h1>

  <!-- Sincronizaci√≥n -->
  <div class="card no-print">
    <h3>üîÑ Sincronizaci√≥n autom√°tica (Firebase)</h3>
    <div class="grid2">
      <div>
        <label>Clave de empresa (ej. TMP-CUU)</label>
        <input id="companyKey" placeholder="Ej: TMP-CUU">
      </div>
      <div class="row" style="align-items:end">
        <button class="secondary" id="btnGuardarClave">Guardar clave</button>
        <span id="syncStatus" class="muted">Estado: sin sincronizar</span>
      </div>
    </div>
    <div id="msg"></div>
    <div class="muted" style="margin-top:6px">Con clave guardada: sincroniza <b>clientes</b>, <b>productos</b>, <b>historial</b> y <b>datos bancarios</b> en autom√°tico.</div>
  </div>

  <!-- Acciones -->
  <div class="actions no-print">
    <button id="btnGuardarNota">üíæ Guardar / Nuevo folio</button>
    <button class="secondary" id="btnVerHist">üìú Ver historial</button>
    <button class="secondary" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
    <button class="secondary" id="btnExportPDF">‚¨áÔ∏è Exportar PDF</button>
  </div>

  <!-- Encabezado + nota (√°rea imprimible) -->
  <div id="printArea" class="card">
    <div class="between row">
      <div>
        <h3 style="margin:0">Gilberto Morales Vargas</h3>
        <p style="margin:0">Chihuahua, M√©xico</p>
        <p style="margin:0">RFC: <b>MOVG850703SL4</b> ¬∑ Tel: <b>614 176 5850</b></p>
        <p style="margin:0">Email: <a href="mailto:gmorales.tmp@gmail.com">gmorales.tmp@gmail.com</a></p>
      </div>
      <div class="right">
        <div style="font-weight:700">Nota de remisi√≥n</div>
        <div id="folio">TMP-CHIH-0001</div>
        <div id="fecha" class="muted"></div>
      </div>
    </div>

    <div class="line"></div>

    <!-- Cliente -->
    <h3>Cliente</h3>
    <div class="grid2">
      <div>
        <label>Seleccionar cliente guardado</label>
        <select id="selCliente"></select>
      </div>
      <div class="row no-print" style="align-items:end">
        <button class="secondary" id="btnGuardarCliente">üìá Guardar cliente actual</button>
        <button class="secondary" id="btnAdminClientes">‚öôÔ∏è Ver clientes</button>
      </div>
      <div>
        <label>Nombre</label>
        <input id="cliente" placeholder="Nombre del cliente">
      </div>
      <div>
        <label>Direcci√≥n</label>
        <input id="direccion" placeholder="Direcci√≥n del cliente">
      </div>
    </div>

    <!-- Admin clientes -->
    <div id="adminClientes" class="no-print" style="display:none;margin-top:8px">
      <div class="line"></div>
      <h4>Clientes guardados</h4>
      <div id="listaClientes"></div>
    </div>

    <div class="line"></div>

    <!-- Conceptos -->
    <div class="between row">
      <h3 style="margin:0">Conceptos</h3>
      <div class="row no-print">
        <button class="secondary" id="btnAdminProductos">‚öôÔ∏è Ver productos</button>
        <button id="btnAddConcepto" type="button" onclick="addItem()">‚ûï Agregar concepto</button>
      </div>
    </div>

    <div id="items"></div>

    <!-- Admin productos -->
    <div id="adminProductos" class="no-print" style="display:none;margin-top:8px">
      <div class="line"></div>
      <h4>Productos guardados</h4>
      <div id="listaProductos"></div>
    </div>

    <!-- Totales -->
    <div class="line"></div>
    <div class="grid2">
      <div>
        <label>Descuento (%)</label>
        <input type="number" id="descuento" value="0" min="0" max="100" step="0.5" oninput="calc()">
      </div>
      <div class="right">
        <p>Subtotal (IVA incluido): <b id="subtotal">$0</b></p>
        <p>Descuento: -<span id="descMonto">$0</span></p>
        <p><b>Total: <span id="total">$0</span></b></p>
      </div>
    </div>

    <div class="line"></div>
    <textarea id="notas" rows="3" placeholder="Notas adicionales"></textarea>

    <!-- DATOS PARA PAGO (se imprime) -->
    <div class="line"></div>
    <div class="paybox" id="bankPrint">
      <b>Datos para pago</b>
      <div id="bankRender" class="muted" style="margin-top:6px">
        <!-- Se llena por JS -->
      </div>
    </div>
  </div>

  <!-- Configurar datos bancarios (NO se imprime) -->
  <div class="card no-print">
    <h3>üè¶ Datos bancarios (se imprimen en la nota)</h3>
    <div class="grid2">
      <div>
        <label>Banco</label>
        <input id="bankBanco" placeholder="Ej. BBVA, Santander, Banorte">
      </div>
      <div>
        <label>Beneficiario</label>
        <input id="bankBenef" placeholder="Nombre del beneficiario">
      </div>
      <div>
        <label>CLABE</label>
        <input id="bankClabe" placeholder="18 d√≠gitos">
      </div>
      <div>
        <label>Cuenta</label>
        <input id="bankCuenta" placeholder="N√∫mero de cuenta">
      </div>
      <div>
        <label>Referencia</label>
        <input id="bankRef" placeholder="Texto de referencia">
      </div>
      <div class="row" style="align-items:end">
        <button id="btnSaveBank" class="secondary">Guardar datos bancarios</button>
        <span id="bankStatus" class="muted">Sin guardar</span>
      </div>
    </div>
  </div>

  <!-- Historial -->
  <div id="histCard" class="card no-print" style="display:none">
    <div class="between row">
      <h3 style="margin:0">Historial de notas</h3>
      <div class="row">
        <input id="buscarHist" placeholder="Buscar por folio o cliente" style="max-width:260px">
        <button class="danger" id="btnClearHistLocal">üóëÔ∏è Borrar historial (local)</button>
        <button class="danger" id="btnClearHistCloud">üóëÔ∏è Borrar historial (nube)</button>
      </div>
    </div>
    <div class="line"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Fecha</th><th>Folio</th><th>Cliente</th><th>Total</th><th>Origen</th><th>Acciones</th></tr></thead>
        <tbody id="tbodyHist"></tbody>
      </table>
    </div>
  </div>

<!-- Librer√≠as PDF -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script type="module">
/* ===== Utilidades y estado ===== */
const mxn = new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"});
const $ = id => document.getElementById(id);
const LS = {
  CLIENTES:'tmp_clientes', PRODUCTOS:'tmp_productos', FOLIO:'tmp_folio',
  COMPANY:'tmp_company', HIST:'tmp_hist', BANK:'tmp_bank'
};
const state = {
  nota:{items:[]},
  clientes:[], productos:[],
  histLocal:[], histMerged:[],
  companyKey: localStorage.getItem(LS.COMPANY)||"",
  editProdIndex: null,
  editProdDraft: null,
  bank: { banco:"", beneficiario:"", clabe:"", cuenta:"", referencia:"" }
};

/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, deleteDoc, addDoc, getDoc, getDocs,
  onSnapshot, query, orderBy, limit, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVBZPlMSMCnypOjexBHLLd-w7Xmd1ndn0",
  authDomain: "notas-tmp.firebaseapp.com",
  projectId: "notas-tmp",
  storageBucket: "notas-tmp.firebasestorage.app",
  messagingSenderId: "640595451791",
  appId: "1:640595451791:web:dd150bca4cfb8cbc6735fa",
  measurementId: "G-JZZPDPNE03"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const colClientes = ()=>collection(db,"companies",state.companyKey,"clientes");
const colProductos= ()=>collection(db,"companies",state.companyKey,"productos");
const colHistorial= ()=>collection(db,"companies",state.companyKey,"historial");
const docBank     = ()=>doc(db,"companies",state.companyKey,"config","bank");

let unsubC=null,unsubP=null,unsubH=null,unsubB=null;

async function ensureAuth(){
  try{ await signInAnonymously(auth); $('syncStatus').textContent=`Estado: sincronizado (${state.companyKey})`; }
  catch(e){ $('syncStatus').textContent="Estado: sin sincronizar"; }
}
function attachCloudListeners(){
  if(!state.companyKey) return;
  unsubC&&unsubC(); unsubP&&unsubP(); unsubH&&unsubH(); unsubB&&unsubB();
  unsubC=onSnapshot(query(colClientes(),orderBy("nombre")),s=>{ const arr=[]; s.forEach(d=>arr.push(d.data())); if(arr.length){ state.clientes=arr; saveLocal(); renderClientes(); }});
  unsubP=onSnapshot(query(colProductos(),orderBy("nombre")),s=>{
    const arr=[]; s.forEach(d=>arr.push(d.data()));
    if(arr.length){ state.productos=arr; saveLocal(); refreshProductSelects(); renderProductosList(); }
  });
  unsubH=onSnapshot(query(colHistorial(),orderBy("ts","desc"),limit(200)),s=>{
    const cloud=[]; s.forEach(d=>cloud.push({...d.data(), _id:d.id, origen:"Nube"}));
    state.histMerged = mergeHist(cloud, state.histLocal);
    renderHistTable(state.histMerged);
  });
  unsubB=onSnapshot(docBank(), snap=>{
    if(snap.exists()){
      state.bank = snap.data();
      saveBankLocal();
      fillBankForm();
      renderBankInPrint();
      $('bankStatus').textContent = 'Sincronizado';
    }
  });
}
async function cloudUpsertCliente(c){ if(state.companyKey) try{ await setDoc(doc(colClientes(),c.nombre),c);}catch{} }
async function cloudDeleteCliente(n){ if(state.companyKey) try{ await deleteDoc(doc(colClientes(),n));}catch{} }
async function cloudUpsertProducto(p){ if(state.companyKey) try{ await setDoc(doc(colProductos(),p.nombre),p);}catch{} }
async function cloudDeleteProducto(n){ if(state.companyKey) try{ await deleteDoc(doc(colProductos(),n));}catch{} }
async function cloudAddHist(h){ if(state.companyKey) try{ await addDoc(colHistorial(),{...h, ts:serverTimestamp()});}catch{} }
async function cloudSaveBank(){
  if(!state.companyKey) return;
  try{ await setDoc(docBank(), state.bank); $('bankStatus').textContent='Guardado en nube ‚úÖ'; }
  catch(e){ $('bankStatus').textContent='Error al guardar en nube'; }
}

/* ===== Local ===== */
function loadLocal(){
  try{state.clientes=JSON.parse(localStorage.getItem(LS.CLIENTES)||"[]")}catch{}
  try{state.productos=JSON.parse(localStorage.getItem(LS.PRODUCTOS)||"[]")}catch{}
  try{state.histLocal=JSON.parse(localStorage.getItem(LS.HIST)||"[]")}catch{}
  try{state.bank=JSON.parse(localStorage.getItem(LS.BANK)||"{}")}catch{}
  state.bank = Object.assign({banco:"",beneficiario:"",clabe:"",cuenta:"",referencia:""}, state.bank||{});
}
function saveLocal(){
  localStorage.setItem(LS.CLIENTES,JSON.stringify(state.clientes));
  localStorage.setItem(LS.PRODUCTOS,JSON.stringify(state.productos));
}
function saveHistLocal(arr){ state.histLocal=arr; localStorage.setItem(LS.HIST,JSON.stringify(arr)); }
function saveBankLocal(){ localStorage.setItem(LS.BANK, JSON.stringify(state.bank)); }

/* ===== Mensajes ===== */
function msg(txt, ok=true){ const m=$('msg'); m.style.display='block'; m.className= ok?'ok':'err'; m.textContent=txt; if(ok) setTimeout(()=>m.style.display='none',4000); }

/* ===== UI Inicial ===== */
function currentFolioPrefix(){ return (state.companyKey || 'TMP-CHIH') + '-'; }
function initUI(){
  $('fecha').textContent=new Date().toLocaleDateString('es-MX');
  const folioNum=Number(localStorage.getItem(LS.FOLIO)||1);
  $('folio').textContent=currentFolioPrefix()+String(folioNum).padStart(4,'0');

  $('companyKey').value=state.companyKey;
  renderClientes(); renderProductosList();
  if(state.nota.items.length===0) addItem(); calc();

  // Bank form inicial
  fillBankForm();
  renderBankInPrint();

  $('btnGuardarClave').onclick=async()=>{
    const key=($('companyKey').value||"").trim();
    state.companyKey=key; localStorage.setItem(LS.COMPANY,key);
    const num=Number(localStorage.getItem(LS.FOLIO)||1);
    $('folio').textContent=currentFolioPrefix()+String(num).padStart(4,'0');
    if(!key){ $('syncStatus').textContent="Estado: sin sincronizar"; msg("Clave eliminada. Solo guardado local.",true); return; }
    await ensureAuth(); attachCloudListeners(); msg("Sincronizaci√≥n autom√°tica activada ‚úÖ");
  };

  $('btnGuardarCliente').onclick=guardarCliente;
  $('btnAdminClientes').onclick=()=>{ const p=$('adminClientes'); p.style.display=p.style.display==='none'?'block':'none'; renderClientesList(); };
  $('selCliente').onchange=()=>{ const v=$('selCliente').value; if(v==="") return; const c=state.clientes[Number(v)]; $('cliente').value=c?.nombre||''; $('direccion').value=c?.direccion||''; };

  $('btnGuardarNota').onclick=guardarNota;
  $('btnVerHist').onclick=()=>{ const c=$('histCard'); c.style.display=c.style.display==='none'?'block':'none'; renderHistTable(state.histMerged.length?state.histMerged:mergeHist(null,state.histLocal)); };
  $('buscarHist').oninput=()=>renderHistTable(state.histMerged.length?state.histMerged:mergeHist(null,state.histLocal));

  $('btnAdminProductos').onclick=()=>{ const p=$('adminProductos'); p.style.display=p.style.display==='none'?'block':'none'; renderProductosList(); };

  $('btnClearHistLocal').onclick=clearHistLocal;
  $('btnClearHistCloud').onclick=clearHistCloud;

  $('btnExportPDF').onclick=exportPDF;

  // Guardar banco
  $('btnSaveBank').onclick=saveBankFromForm;
}

/* ===== Clientes ===== */
function renderClientes(){
  const sel=$('selCliente');
  sel.innerHTML='<option value="">‚Äî Elegir cliente ‚Äî</option>'+state.clientes.map((c,i)=>`<option value="${i}">${c.nombre}</option>`).join('');
}
function renderClientesList(){
  const cont=$('listaClientes'); cont.innerHTML='';
  if(state.clientes.length===0){ cont.innerHTML='<div class="muted">No hay clientes guardados.</div>'; return; }
  state.clientes.forEach((c,i)=>{
    const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
    row.innerHTML=`<div><b>${c.nombre}</b><br><small>${c.direccion||'‚Äî'}</small></div><button class="danger">Eliminar</button>`;
    row.querySelector('button').onclick=async()=>{ const n=state.clientes[i].nombre; state.clientes.splice(i,1); saveLocal(); renderClientes(); renderClientesList(); await cloudDeleteCliente(n); };
    cont.appendChild(row);
  });
}
async function guardarCliente(){
  const nombre=($('cliente').value||'').trim(); const direccion=($('direccion').value||'').trim();
  if(!nombre){ msg("Escribe el nombre del cliente",false); return; }
  const ix=state.clientes.findIndex(c=>c.nombre.toLowerCase()===nombre.toLowerCase());
  if(ix<0) state.clientes.unshift({nombre,direccion}); else state.clientes[ix]={nombre,direccion};
  saveLocal(); renderClientes(); renderClientesList(); await cloudUpsertCliente({nombre,direccion}); msg("Cliente guardado ‚úÖ");
}

/* ===== Productos ===== */
function refreshProductSelects(){
  document.querySelectorAll('.selProducto').forEach((el,idx)=>{
    const d=$('desc-'+idx), p=$('precio-'+idx);
    el.innerHTML='<option value="">‚Äî Producto ‚Äî</option>'+state.productos.map((pr,i)=>`<option value="${i}">${pr.nombre} (${mxn.format(pr.precio)})</option>`).join('');
    el.onchange=()=>{ const v=el.value; if(v==="") return; const pr=state.productos[Number(v)];
      d.value=pr.nombre; p.value=pr.precio; state.nota.items[idx].descripcion=pr.nombre; state.nota.items[idx].precio=Number(pr.precio||0); calc(); };
  });
}
function renderProductosList(){
  const cont=$('listaProductos'); if(!cont) return; cont.innerHTML='';
  if(state.productos.length===0){ cont.innerHTML='<div class="muted">No hay productos guardados.</div>'; return; }
  state.productos.forEach((p,i)=>{
    const isEdit = state.editProdIndex===i;
    const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.flexWrap='wrap';

    if(isEdit){
      const draft = state.editProdDraft || {nombre:p.nombre, precio:p.precio, oldName:p.nombre};
      row.innerHTML = `
        <div class="row" style="gap:8px;flex:1">
          <input id="editNombre" value="${draft.nombre}" placeholder="Nombre" style="min-width:220px">
          <input id="editPrecio" type="number" value="${draft.precio}" min="0" step="0.01" style="width:140px">
        </div>
        <div class="row">
          <button id="btnSaveEdit">Guardar</button>
          <button class="secondary" id="btnCancelEdit">Cancelar</button>
        </div>`;
      row.querySelector('#editNombre').oninput = (e)=>{ state.editProdDraft = {...draft, nombre:e.target.value}; };
      row.querySelector('#editPrecio').oninput = (e)=>{ state.editProdDraft = {...(state.editProdDraft||draft), precio:Number(e.target.value||0)}; };
      row.querySelector('#btnSaveEdit').onclick = ()=>saveEditProducto(i);
      row.querySelector('#btnCancelEdit').onclick = ()=>{ state.editProdIndex=null; state.editProdDraft=null; renderProductosList(); };
    } else {
      row.innerHTML=`<div><b>${p.nombre}</b> ‚Äî ${mxn.format(p.precio)}</div>
                     <div class="row">
                       <button class="secondary">Editar</button>
                       <button class="danger">Eliminar</button>
                     </div>`;
      row.querySelector('.secondary').onclick=()=>{
        state.editProdIndex=i;
        state.editProdDraft={nombre:p.nombre, precio:p.precio, oldName:p.nombre};
        renderProductosList();
      };
      row.querySelector('.danger').onclick=async()=>{
        if(!confirm(`Eliminar producto "${p.nombre}"?`)) return;
        const nombre = p.nombre;
        state.productos.splice(i,1); saveLocal(); refreshProductSelects(); renderProductosList();
        await cloudDeleteProducto(nombre);
      };
    }
    cont.appendChild(row);
  });
}
async function saveEditProducto(i){
  const draft = state.editProdDraft;
  if(!draft || !draft.nombre?.trim()){ msg("Escribe el nombre del producto", false); return; }
  const newName = draft.nombre.trim();
  const newPrice = Number(draft.precio||0);
  const oldName = draft.oldName;
  const dupIx = state.productos.findIndex((pp,ix)=>pp.nombre.toLowerCase()===newName.toLowerCase() && ix!==i);
  if(dupIx>=0){ msg("Ya existe un producto con ese nombre", false); return; }
  state.productos[i] = {nombre:newName, precio:newPrice};
  saveLocal(); refreshProductSelects(); renderProductosList();
  await cloudUpsertProducto({nombre:newName, precio:newPrice});
  if(oldName && oldName !== newName){ await cloudDeleteProducto(oldName); }
  state.editProdIndex=null; state.editProdDraft=null; msg("Producto actualizado ‚úÖ");
}
async function guardarProductoDesdeFila(idx){
  const nombre=($('desc-'+idx).value||'').trim(); const precio=Number($('precio-'+idx).value||0);
  if(!nombre){ msg("Escribe la descripci√≥n del producto",false); return; }
  const ix=state.productos.findIndex(p=>p.nombre.toLowerCase()===nombre.toLowerCase());
  if(ix<0) state.productos.unshift({nombre,precio}); else state.productos[ix]={nombre,precio};
  saveLocal(); refreshProductSelects(); renderProductosList(); await cloudUpsertProducto({nombre,precio}); msg("Producto guardado ‚úÖ");
}
window.guardarProductoDesdeFila = guardarProductoDesdeFila;

/* ===== √çtems y totales ===== */
function addItem(){
  const idx=state.nota.items.length; state.nota.items.push({descripcion:'',cantidad:1,precio:0});
  const row=document.createElement('div'); row.className='card'; row.style.padding='10px'; row.style.margin='8px 0';
  row.innerHTML=`
    <div class="grid3">
      <div><label>Descripci√≥n</label><input id="desc-${idx}" placeholder="Descripci√≥n"></div>
      <div><label>Cantidad</label><input type="number" id="cant-${idx}" value="1" min="1"></div>
      <div><label>Precio</label><input type="number" id="precio-${idx}" value="0" min="0"></div>
    </div>
    <div class="row" style="margin-top:6px;justify-content:space-between">
      <div class="row" style="flex:1">
        <select class="selProducto" id="sel-${idx}" style="flex:1"></select>
        <button class="secondary" onclick="guardarProductoDesdeFila(${idx})">üíæ Guardar como producto</button>
      </div>
      <div class="row">
        <div class="right" style="min-width:140px"><b id="total-${idx}">$0</b></div>
        <button class="danger" onclick="removeItem(${idx})">üóëÔ∏è</button>
      </div>
    </div>`;
  $('items').appendChild(row);
  $('desc-'+idx).oninput=()=>{state.nota.items[idx].descripcion=$('desc-'+idx).value; calc();}
  $('cant-'+idx).oninput=()=>{state.nota.items[idx].cantidad=Number($('cant-'+idx).value||0); calc();}
  $('precio-'+idx).oninput=()=>{state.nota.items[idx].precio=Number($('precio-'+idx).value||0); calc();}
  refreshProductSelects(); calc();
}
window.addItem=addItem;

function removeItem(i){
  state.nota.items.splice(i,1);
  const backup=[...state.nota.items]; $('items').innerHTML=''; state.nota.items=[];
  backup.forEach(()=>addItem()); backup.forEach((it,ix)=>{ $('desc-'+ix).value=it.descripcion||''; $('cant-'+ix).value=it.cantidad||1; $('precio-'+ix).value=it.precio||0; state.nota.items[ix]=it; });
  calc();
}
function calc(){
  let subtotal=0; state.nota.items.forEach((it,i)=>{ const t=Number(it.cantidad||0)*Number(it.precio||0); subtotal+=t; const el=$('total-'+i); if(el) el.textContent=mxn.format(t); });
  const desc=subtotal*(Number($('descuento').value||0)/100); const total=Math.max(0,subtotal-desc);
  $('subtotal').textContent=mxn.format(subtotal); $('descMonto').textContent=mxn.format(desc); $('total').textContent=mxn.format(total);
}

/* ===== Historial ===== */
function mergeHist(cloud, local){
  const L = (local||[]).map((h,i)=>({...h,_localIndex:i,origen:h.origen||"Local"}));
  const C = (cloud||[]);
  return [...C, ...L];
}
function renderHistTable(data){
  const term = ($('buscarHist')?.value||'').toLowerCase();
  const rows = (data || state.histLocal)
    .filter(h => !term || (h.folio||'').toLowerCase().includes(term) || (h.cliente||'').toLowerCase().includes(term))
    .map(h=>{
      const useBtn = h._id
        ? `<button class="secondary" onclick="usarNotaNube('${h._id}')">Usar esta nota</button>`
        : (typeof h._localIndex==='number' ? `<button class="secondary" onclick="usarNotaLocal(${h._localIndex})">Usar esta nota</button>` : '');
      return `<tr>
        <td>${h.fecha||'‚Äî'}</td>
        <td>${h.folio||'‚Äî'}</td>
        <td>${h.cliente||'‚Äî'}</td>
        <td>${h.total||'‚Äî'}</td>
        <td>${h.origen||'‚Äî'}</td>
        <td>${useBtn}</td>
      </tr>`;
    })
    .join('');
  $('tbodyHist').innerHTML = rows || `<tr><td colspan="6" class="muted">Sin registros.</td></tr>`;
}
function cargarNotaEnFormulario(h){
  $('cliente').value = h.cliente || '';
  $('direccion').value = h.direccion || '';
  $('descuento').value = h.descuentoPorc || 0;
  $('notas').value = h.notas || '';
  state.nota.items = []; $('items').innerHTML = '';
  (h.items||[]).forEach(it=>{
    addItem();
    const i = state.nota.items.length - 1;
    $('desc-'+i).value = it.descripcion || '';
    $('cant-'+i).value = it.cantidad || 0;
    $('precio-'+i).value = it.precio || 0;
    state.nota.items[i] = {descripcion:it.descripcion, cantidad:it.cantidad, precio:it.precio};
  });
  calc();
  alert("Nota cargada en el formulario ‚úÖ Ed√≠tala y guarda para generar un nuevo folio.");
  window.scrollTo({top:0,behavior:'smooth'});
}
window.usarNotaLocal = (i)=>{ if(i<0) return; const h = state.histLocal[i]; if(!h) return; cargarNotaEnFormulario(h); };
window.usarNotaNube = async (id)=>{ try{ const snap = await getDoc(doc(colHistorial(), id)); if(!snap.exists()) return; cargarNotaEnFormulario(snap.data()); } catch(e){ alert("No se pudo cargar la nota de la nube"); } };

async function guardarNota(){
  const snapshot = {
    folio: $('folio').textContent,
    fecha: new Date().toLocaleDateString('es-MX'),
    cliente: $('cliente').value || '‚Äî',
    direccion: $('direccion').value || '',
    items: state.nota.items.map(it=>({descripcion:it.descripcion,cantidad:Number(it.cantidad||0),precio:Number(it.precio||0)})),
    descuentoPorc: Number($('descuento').value||0),
    notas: $('notas').value || '',
    subtotal: $('subtotal').textContent,
    total: $('total').textContent,
    origen: 'Local'
  };
  const hist = JSON.parse(localStorage.getItem(LS.HIST)||"[]"); hist.unshift(snapshot); saveHistLocal(hist);
  await cloudAddHist(snapshot);

  let folioNum=Number(localStorage.getItem(LS.FOLIO)||1); folioNum++; localStorage.setItem(LS.FOLIO,folioNum);
  alert("Nota guardada ‚úÖ Nuevo folio: "+currentFolioPrefix()+String(folioNum).padStart(4,'0'));
  location.reload();
}

/* Borrar historial */
function clearHistLocal(){
  if(!confirm("¬øBorrar TODO el historial local? Esta acci√≥n no se puede deshacer.")) return;
  saveHistLocal([]); renderHistTable([]); msg("Historial local borrado ‚úÖ");
}
async function clearHistCloud(){
  if(!state.companyKey){ alert("Primero guarda una clave de empresa para usar la nube."); return; }
  if(!confirm("¬øBorrar TODO el historial en la nube para esta clave?")) return;
  try{
    const snaps = await getDocs(colHistorial());
    const ops = [];
    snaps.forEach(d=>ops.push(deleteDoc(d.ref)));
    await Promise.all(ops);
    msg("Historial en la nube borrado ‚úÖ");
  }catch(e){ msg("No se pudo borrar el historial en la nube", false); }
}

/* ===== Datos bancarios ===== */
function fillBankForm(){
  $('bankBanco').value = state.bank.banco || '';
  $('bankBenef').value = state.bank.beneficiario || '';
  $('bankClabe').value = state.bank.clabe || '';
  $('bankCuenta').value = state.bank.cuenta || '';
  $('bankRef').value = state.bank.referencia || '';
}
function renderBankInPrint(){
  const b = state.bank;
  const fmtClabe = (b.clabe||'').replace(/\s+/g,'').replace(/(\d{4})(?=\d)/g,'$1 ');
  const lines = [];
  if(b.banco) lines.push(`<b>Banco:</b> ${b.banco}`);
  if(b.beneficiario) lines.push(`<b>Beneficiario:</b> ${b.beneficiario}`);
  if(b.clabe) lines.push(`<b>CLABE:</b> ${fmtClabe}`);
  if(b.cuenta) lines.push(`<b>Cuenta:</b> ${b.cuenta}`);
  if(b.referencia) lines.push(`<b>Referencia:</b> ${b.referencia}`);
  $('bankRender').innerHTML = lines.length ? lines.map(l=>`<div>${l}</div>`).join('') : '<span class="muted">Configura tus datos en la tarjeta ‚ÄúDatos bancarios‚Äù.</span>';
}
async function saveBankFromForm(){
  state.bank = {
    banco: $('bankBanco').value.trim(),
    beneficiario: $('bankBenef').value.trim(),
    clabe: $('bankClabe').value.trim(),
    cuenta: $('bankCuenta').value.trim(),
    referencia: $('bankRef').value.trim()
  };
  saveBankLocal();
  renderBankInPrint();
  $('bankStatus').textContent = 'Guardado local ‚úÖ';
  await cloudSaveBank();
}

/* ===== Exportar PDF ===== */
async function exportPDF(){
  const area = document.getElementById('printArea');
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(area, { scale: 2, backgroundColor: "#ffffff" });
  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgWidth = pageWidth - 40; const imgHeight = (canvas.height * imgWidth) / canvas.width; let y = 20;
  if (imgHeight > pageHeight - 40) {
    let remaining = imgHeight; const fullCanvasHeight = canvas.height; const sliceHeightPx = Math.floor((pageHeight - 40) * (canvas.width / imgWidth)); let position = 0;
    while (remaining > 0) {
      const slice = document.createElement('canvas'); slice.width = canvas.width; slice.height = Math.min(sliceHeightPx, fullCanvasHeight - position);
      const ctx = slice.getContext('2d'); ctx.drawImage(canvas, 0, position, canvas.width, slice.height, 0, 0, canvas.width, slice.height);
      const sliceImg = slice.toDataURL('image/jpeg', 0.95); const sliceHpt = (slice.height * imgWidth) / canvas.width;
      pdf.addImage(sliceImg, 'JPEG', 20, y, imgWidth, sliceHpt, undefined, 'FAST');
      position += slice.height; remaining -= sliceHpt; if (position < fullCanvasHeight) pdf.addPage();
    }
  } else {
    pdf.addImage(imgData, 'JPEG', 20, y, imgWidth, imgHeight, undefined, 'FAST');
  }
  const folio = (document.getElementById('folio')?.textContent || 'FOLIO').trim();
  const cliente = (document.getElementById('cliente')?.value || 'Cliente').trim();
  const sanitize = s => s.replace(/[^\w\-]+/g,'-').slice(0,80);
  const filename = `${sanitize(folio)}_${sanitize(cliente || 'Cliente')}.pdf`;
  pdf.save(filename);
}

/* ===== Bootstrap ===== */
window.addEventListener('error', e=>msg(e.message||'Error',false));
window.addEventListener('unhandledrejection', e=>msg((e.reason&&e.reason.message)||'Error',false));

(function start(){
  try{
    loadLocal();
    initUI();
    renderHistTable(state.histLocal);
    if(state.companyKey){ ensureAuth().then(attachCloudListeners); }
  }catch(e){ console.error(e); msg("Error al iniciar: "+e.message,false); }
})();
</script>
</body>
</html>
