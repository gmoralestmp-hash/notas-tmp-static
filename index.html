<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Notas TMP Regenerative</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#00b5ad" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-512.png" />
  <meta name="apple-mobile-web-app-title" content="Notas TMP" />
  <style>
    :root{--c:#00b5ad}
    body{font-family:system-ui,sans-serif;background:#f8fafc;color:#222;margin:0}
    .page{padding:16px}
    h1{text-align:center;color:var(--c);margin:16px 0}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:16px;max-width:1000px;margin:20px auto}
    .row{display:flex;align-items:center;gap:8px}
    .between{justify-content:space-between}
    .actions{text-align:center;margin:16px auto;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:1000px}
    button{background:var(--c);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    button.secondary{background:#e6f7f6;color:#0d6662}
    button.danger{background:#e55252}
    input,textarea,select{border:1px solid #cfd6de;border-radius:8px;padding:8px 10px;width:100%;font-size:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px}
    .line{border-top:1px solid #e5e7eb;margin:12px 0}
    .total{font-weight:700}
    .right{text-align:right}
    .admin{display:none;padding:12px;border:1px dashed #cfd6de;border-radius:10px;background:#fafcff;margin-top:8px}
    .admin-list .row{justify-content:space-between;padding:6px 0;border-bottom:1px solid #eef2f6}
    .admin-list .row:last-child{border-bottom:none}
    .muted{color:#6b7785;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f6;text-align:left;font-size:14px}
    th{background:#f3f6f9}

    /* Mensajes */
    #msgBar{margin-top:8px;display:none}
    .msg-ok{ color:#0e7a72; background:#e7fbf9; border:1px solid #b7efea; padding:8px 10px; border-radius:8px }
    .msg-err{ color:#8a1e1e; background:#fdecec; border:1px solid #f5bcbc; padding:8px 10px; border-radius:8px }

    /* ---- Estilos de impresi√≥n ---- */
    #printHeader,#printFooter{display:none}
    @media print{
      body{background:#fff}
      .actions,.no-print,.admin,#historialCard{display:none!important}
      .card{box-shadow:none}
      #printHeader,#printFooter{
        display:block; position:fixed; left:0; right:0; color:#444; font-size:12px; background:#fff;
        padding:6px 16px; z-index:9999
      }
      #printHeader{top:0; border-bottom:1px solid #ddd}
      #printFooter{bottom:0; border-top:1px solid #ddd}
      .page{padding-top:64px; padding-bottom:56px}
      .card, .item-card{page-break-inside:avoid}
      .line{page-break-after:auto}
    }
  </style>
</head>
<body>
  <!-- Barras de impresi√≥n -->
  <div id="printHeader"></div>
  <div id="printFooter"></div>

  <div class="page" id="page">
    <h1>Notas de Remisi√≥n TMP Regenerative</h1>

    <div id="acciones" class="actions">
      <button onclick="guardarHistorial()">üíæ Guardar / Nuevo folio</button>
      <button onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
      <button class="secondary" onclick="toggleHistorial()">üìú Ver historial</button>
      <button class="secondary" onclick="exportarPDF()">üìÑ Exportar PDF (con nombre)</button>
    </div>

    <!-- SINCRONIZACI√ìN -->
    <div class="card no-print">
      <h3 style="margin:6px 0">üîÑ Sincronizaci√≥n en la nube (Firebase)</h3>
      <div class="grid2">
        <div>
          <label>Clave de empresa (usa una por sucursal/usuario, ej. TMP-CHIH)</label>
          <input id="companyKey" placeholder="Ej: TMP-CHIH">
        </div>
        <div class="row" style="align-items:end">
          <div class="row" style="gap:8px">
            <button class="secondary" onclick="activarSync()">Activar sync</button>
            <button class="danger" onclick="desactivarSync()">Desactivar</button>
          </div>
        </div>
      </div>
      <div class="muted" id="syncStatus" style="margin-top:6px">Estado: sin sincronizar</div>
      <div id="msgBar" class="muted"></div>
      <div class="row" style="margin-top:10px; gap:8px">
        <button class="secondary" onclick="probarSync()">üîé Probar sync</button>
        <span class="muted">Verifica lectura/escritura en Firestore.</span>
      </div>
    </div>

    <!-- HISTORIAL -->
    <div id="historialCard" class="card no-print" style="display:none">
      <div class="row between">
        <h3 style="margin:6px 0">Historial de notas</h3>
        <div class="row">
          <input id="buscaHist" placeholder="Buscar por folio o cliente" oninput="renderHistorial()" style="width:220px" />
          <button class="danger" onclick="borrarHistorialLocal()">üóëÔ∏è Limpiar local</button>
        </div>
      </div>
      <div class="line"></div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr><th>Fecha</th><th>Folio</th><th>Cliente</th><th>Total</th><th>Origen</th><th class="no-print">Acciones</th></tr>
          </thead>
          <tbody id="tbodyHistorial"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="row between">
        <div>
          <h3 style="margin:0">TMP Regenerative</h3>
          <p style="margin:0">Chihuahua, M√©xico</p>
        </div>
        <div style="text-align:right">
          <img src="./icons/tmp-logo.png" alt="TMP Regenerative" style="height:72px;object-fit:contain">
          <p style="margin:6px 0 0 0;font-weight:700">Nota de remisi√≥n</p>
          <p id="folio" style="margin:0;font-size:14px">TMP-0001</p>
          <p id="fecha" style="margin:0;font-size:13px"></p>
        </div>
      </div>

      <div class="line"></div>

      <!-- CLIENTE -->
      <h3 style="margin:6px 0">Cliente</h3>
      <div class="grid2">
        <div>
          <label>Seleccionar cliente guardado</label>
          <select id="selCliente" onchange="aplicarClienteSeleccionado()">
            <option value="">‚Äî Elegir cliente ‚Äî</option>
          </select>
        </div>
        <div class="row" style="align-items:end">
          <div style="flex:1">
            <label>&nbsp;</label>
            <div class="row">
              <button class="secondary" style="flex:1" onclick="guardarClienteActual()">üìá Guardar cliente actual</button>
              <button class="secondary" style="flex:1" onclick="toggleAdmin('adminClientes')">‚öôÔ∏è Administrar</button>
            </div>
          </div>
        </div>
        <div>
          <label>Nombre</label>
          <input id="cliente" placeholder="Nombre del cliente">
        </div>
        <div>
          <label>Direcci√≥n</label>
          <input id="direccion" placeholder="Direcci√≥n del cliente">
        </div>
      </div>

      <!-- Admin clientes -->
      <div id="adminClientes" class="admin no-print">
        <h4>Clientes guardados</h4>
        <div id="listaClientes" class="admin-list"></div>
        <div class="row between" style="margin-top:8px">
          <div class="row" style="gap:6px">
            <button class="secondary" onclick="exportarCatalogo('clientes')">‚¨áÔ∏è Exportar</button>
            <input type="file" id="importClientesFile" accept="application/json" style="display:none" onchange="importarCatalogo(event,'clientes')" />
            <button class="secondary" onclick="document.getElementById('importClientesFile').click()">‚¨ÜÔ∏è Importar</button>
          </div>
          <button class="danger" onclick="borrarTodosClientes()">üóëÔ∏è Borrar todos</button>
        </div>
      </div>

      <div class="line"></div>

      <!-- CONCEPTOS -->
      <div class="row between">
        <h3 style="margin:6px 0">Conceptos</h3>
        <div class="row">
          <button class="secondary no-print" onclick="toggleAdmin('adminProductos')">‚öôÔ∏è Administrar productos</button>
          <button class="secondary no-print" onclick="addItem()">‚ûï Agregar concepto</button>
        </div>
      </div>

      <div id="items"></div>

      <!-- Admin productos -->
      <div id="adminProductos" class="admin no-print">
        <h4>Productos guardados</h4>
        <div id="listaProductos" class="admin-list"></div>
        <div class="row between" style="margin-top:8px">
          <div class="row" style="gap:6px">
            <button class="secondary" onclick="exportarCatalogo('productos')">‚¨áÔ∏è Exportar</button>
            <input type="file" id="importProductosFile" accept="application/json" style="display:none" onchange="importarCatalogo(event,'productos')" />
            <button class="secondary" onclick="document.getElementById('importProductosFile').click()">‚¨ÜÔ∏è Importar</button>
          </div>
          <button class="danger" onclick="borrarTodosProductos()">üóëÔ∏è Borrar todos</button>
        </div>
      </div>

      <div class="line"></div>

      <!-- TOTALES -->
      <div style="max-width:420px;margin-left:auto;display:grid;gap:8px">
        <div class="row between"><span>Subtotal (IVA incluido)</span><b id="subtotal">$0</b></div>
        <div class="row between" style="align-items:center">
          <div>Descuento</div>
          <div class="row" style="align-items:center">
            <input style="width:90px;text-align:right" type="number" min="0" max="100" step="0.5" id="descuento" value="0" oninput="calc()" />
            <div style="width:24px;text-align:center">%</div>
            <div style="width:130px;text-align:right">-<span id="descMonto">$0</span></div>
          </div>
        </div>
        <div class="row between total"><span>Total</span><b id="total">$0</b></div>
      </div>

      <div class="line"></div>
      <textarea id="notas" placeholder="Notas adicionales" rows="3" style="width:100%"></textarea>
    </div>
  </div>

  <!-- Firebase (m√≥dulos) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, deleteDoc, addDoc, getDoc,
      onSnapshot, getDocs, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Config Firebase (TU proyecto)
    const firebaseConfig = {
      apiKey: "AIzaSyDVBZPlMSMCnypOjexBHLLd-w7Xmd1ndn0",
      authDomain: "notas-tmp.firebaseapp.com",
      projectId: "notas-tmp",
      storageBucket: "notas-tmp.firebasestorage.app",
      messagingSenderId: "640595451791",
      appId: "1:640595451791:web:dd150bca4cfb8cbc6735fa",
      measurementId: "G-JZZPDPNE03"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Utilidades / UI =====
    const mxn = new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"});
    const $ = (id)=>document.getElementById(id);
    const download=(name,content)=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type:'application/json'}));a.download=name;a.click();}
    function showMsg(text, ok=true){
      const bar=$('msgBar'); if(!bar) return;
      bar.style.display='block'; bar.className= ok?'msg-ok':'msg-err'; bar.textContent=text;
      if(ok){ setTimeout(()=>{ bar.style.display='none'; }, 6000); }
    }
    function clearMsg(){ const bar=$('msgBar'); if(bar) bar.style.display='none'; }

    // ===== LocalStorage keys =====
    const LS={FOLIO:"tmp_folio",HIST:"tmp_historial",CLIENTES:"tmp_clientes",PRODUCTOS:"tmp_productos",COMPANY:"tmp_company_key"};

    // ===== Estado =====
    const state={nota:{items:[]},clientes:[],productos:[],histLocal:[],companyKey:localStorage.getItem(LS.COMPANY)||"",histMerged:[]};
    let unsubClientes=null,unsubProductos=null,unsubHist=null;

    // ===== Inicio =====
    document.addEventListener("DOMContentLoaded", async ()=>{
      $('fecha').textContent=new Date().toLocaleDateString("es-MX");
      const folioNum=Number(localStorage.getItem(LS.FOLIO)||1);
      $('folio').textContent="TMP-"+String(folioNum).padStart(4,"0");
      $('companyKey').value=state.companyKey;
      setSyncStatus(state.companyKey?`Con clave: ${state.companyKey}`:"sin sincronizar");

      cargarCatalogosLocal(); cargarHistorialLocal();
      addItem(); calc(); renderHistorial();

      if(state.companyKey){
        await signIn(); activarListeners(); await primeCloud();
      }
      prepararBarrasImpresion();
    });

    const setSyncStatus=(m)=>$('syncStatus').textContent="Estado: "+m;

    // ------- Auth -------
    async function signIn(){
      try{
        const cred = await signInAnonymously(auth);
        const uid = cred.user?.uid || '(sin uid)';
        setSyncStatus(`autenticado UID: ${uid}`);
        return uid;
      }catch(e){
        console.error(e);
        showMsg("No se pudo iniciar sesi√≥n an√≥nima. Revisa Authentication ‚Üí Anonymous.", false);
        throw e;
      }
    }

    // Rutas por compa√±√≠a
    const colClientes = ()=>collection(db,"companies",state.companyKey,"clientes");
    const colProductos= ()=>collection(db,"companies",state.companyKey,"productos");
    const colHistorial = ()=>collection(db,"companies",state.companyKey,"historial");

    // ------- Listeners -------
    function activarListeners(){
      if(!state.companyKey) return;
      unsubClientes && unsubClientes(); unsubProductos && unsubProductos(); unsubHist && unsubHist();

      unsubClientes = onSnapshot(query(colClientes(),orderBy("nombre")),s=>{
        const arr=[]; s.forEach(d=>arr.push(d.data()));
        if(arr.length){ state.clientes=arr; localStorage.setItem(LS.CLIENTES,JSON.stringify(arr)); }
        poblarClientesUI(); if($('#adminClientes').style.display==='block') renderAdminClientes();
        setSyncStatus(`sincronizado (${state.companyKey})`);
      });

      unsubProductos = onSnapshot(query(colProductos(),orderBy("nombre")),s=>{
        const arr=[]; s.forEach(d=>arr.push(d.data()));
        if(arr.length){ state.productos=arr; localStorage.setItem(LS.PRODUCTOS,JSON.stringify(arr)); }
        refrescarSelectsProductos(); if($('#adminProductos').style.display==='block') renderAdminProductos();
      });

      unsubHist = onSnapshot(query(colHistorial(),orderBy("ts","desc"),limit(100)), s=>{
        const cloud=[]; s.forEach(d=>cloud.push({...d.data(), _id:d.id, origen:"Nube"}));
        const local = state.histLocal.map((h,i)=>({...h, _localIndex:i, origen:"Local"}));
        const key = (h)=>h._id || h._localIndex ?? `${h.folio}-${h.fecha}-${h.total}`;
        const seen = new Set(); const merged=[];
        [...cloud, ...local].forEach(h=>{const k=key(h); if(!seen.has(k)){seen.add(k); merged.push(h);}});
        state.histMerged = merged;
        renderHistorial();
      });
    }

    // Sube cat√°logos locales si nube est√° vac√≠a
    async function primeCloud(){
      const cSnap=await getDocs(query(colClientes(),limit(1)));
      const pSnap=await getDocs(query(colProductos(),limit(1)));
      if(cSnap.empty && state.clientes.length){ await Promise.all(state.clientes.map(c=>setDoc(doc(colClientes(),c.nombre),c))); }
      if(pSnap.empty && state.productos.length){ await Promise.all(state.productos.map(p=>setDoc(doc(colProductos(),p.nombre),p))); }
    }

    // ------- Sync UI -------
    window.activarSync = async ()=>{
      clearMsg();
      const key=($('companyKey').value||"").trim();
      if(!key){ showMsg("Escribe una clave (ej: TMP-CHIH)", false); return; }
      state.companyKey=key; localStorage.setItem(LS.COMPANY,key);
      try{
        const uid = await signIn();
        activarListeners(); await primeCloud();
        setSyncStatus(`sincronizado (${key}) ‚Äî UID: ${uid}`);
        showMsg("Sincronizaci√≥n activada ‚úÖ", true);
      }catch(e){ /* signIn ya avis√≥ */ }
    };
    window.desactivarSync = ()=>{
      localStorage.removeItem(LS.COMPANY); state.companyKey="";
      unsubClientes&&unsubClientes(); unsubProductos&&unsubProductos(); unsubHist&&unsubHist();
      setSyncStatus("sin sincronizar"); showMsg("Sincronizaci√≥n desactivada", true);
    };

    // ------- Cat√°logos Local -------
    function cargarCatalogosLocal(){
      try{state.clientes=JSON.parse(localStorage.getItem(LS.CLIENTES)||"[]")}catch{state.clientes=[]}
      try{state.productos=JSON.parse(localStorage.getItem(LS.PRODUCTOS)||"[]")}catch{state.productos=[]}
      poblarClientesUI(); refrescarSelectsProductos();
    }
    function guardarCatalogosLocal(){
      localStorage.setItem(LS.CLIENTES,JSON.stringify(state.clientes));
      localStorage.setItem(LS.PRODUCTOS,JSON.stringify(state.productos));
      poblarClientesUI(); refrescarSelectsProductos();
    }

    // ------- Historial Local -------
    function cargarHistorialLocal(){ try{state.histLocal=JSON.parse(localStorage.getItem(LS.HIST)||"[]")}catch{state.histLocal=[]} }
    function guardarHistorialLocal(arr){ state.histLocal=arr; localStorage.setItem(LS.HIST,JSON.stringify(arr)); }

    // ------- Clientes -------
    function poblarClientesUI(){
      const sel=$('selCliente');
      sel.innerHTML='<option value="">‚Äî Elegir cliente ‚Äî</option>'+state.clientes.map((c,i)=>`<option value="${i}">${c.nombre}</option>`).join('');
    }
    window.aplicarClienteSeleccionado=()=>{
      const idx=$('selCliente').value; if(idx==="") return;
      const c=state.clientes[Number(idx)]; $('cliente').value=c?.nombre||''; $('direccion').value=c?.direccion||'';
    };
    window.guardarClienteActual = async ()=>{
      clearMsg();
      const nombre=($('cliente').value||'').trim(), direccion=($('direccion').value||'').trim();
      if(!nombre){ showMsg("Escribe el nombre del cliente", false); return; }

      const exists=state.clientes.some(c=>c.nombre.toLowerCase()===nombre.toLowerCase());
      if(!exists) state.clientes.unshift({nombre,direccion});
      else state.clientes=state.clientes.map(c=>c.nombre.toLowerCase()===nombre.toLowerCase()?({...c,direccion}):c);
      guardarCatalogosLocal();

      if(state.companyKey){
        try{ await setDoc(doc(colClientes(),nombre),{nombre,direccion}); showMsg("Cliente guardado y sincronizado ‚úÖ"); }
        catch(err){ console.error(err); showMsg("No se pudo guardar en la nube. Qued√≥ local.", false); return; }
      }else{ showMsg("Cliente guardado localmente (sin clave de sync).", true); }
    };
    function renderAdminClientes(){
      const cont=$('listaClientes'); cont.innerHTML='';
      if(state.clientes.length===0){ cont.innerHTML='<div class="muted">No hay clientes guardados.</div>'; return; }
      state.clientes.forEach((c,i)=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div><b>${c.nombre}</b><br><small>${c.direccion||'‚Äî'}</small></div>
                       <button class="danger" onclick="eliminarCliente(${i})">Eliminar</button>`;
        cont.appendChild(row);
      });
    }
    window.eliminarCliente = async (i)=>{
      const nombre=state.clientes[i].nombre;
      state.clientes.splice(i,1); guardarCatalogosLocal();
      if(state.companyKey){ await deleteDoc(doc(colClientes(),nombre)).catch(()=>{}); }
      renderAdminClientes();
    };
    window.borrarTodosClientes = async ()=>{
      if(!confirm("¬øBorrar todos los clientes?")) return;
      const arr=[...state.clientes]; state.clientes=[]; guardarCatalogosLocal();
      if(state.companyKey){ await Promise.all(arr.map(c=>deleteDoc(doc(colClientes(),c.nombre)).catch(()=>{}))); }
      renderAdminClientes();
    };

    // ------- Productos -------
    function refrescarSelectsProductos(){
      document.querySelectorAll('.selProducto').forEach((el,idx)=>poblarSelectProducto(el,$('item-desc-'+idx),$('item-precio-'+idx)));
    }
    function poblarSelectProducto(selectEl,descEl,precioEl){
      selectEl.innerHTML='<option value="">‚Äî Producto ‚Äî</option>'+state.productos.map((p,i)=>`<option value="${i}">${p.nombre} (${mxn.format(p.precio)})</option>`).join('');
      selectEl.onchange=()=>{ const idx=selectEl.value; if(idx==="") return; const p=state.productos[Number(idx)];
        descEl.value=p.nombre; precioEl.value=p.precio; descEl.dispatchEvent(new Event('input')); precioEl.dispatchEvent(new Event('input')); };
    }
    window.guardarProductoDesdeFila = async (idx)=>{
      clearMsg();
      const desc=$('item-desc-'+idx).value.trim(), precio=Number($('item-precio-'+idx).value||0);
      if(!desc){ showMsg("Escribe la descripci√≥n del producto", false); return; }

      const exists=state.productos.some(p=>p.nombre.toLowerCase()===desc.toLowerCase());
      if(!exists) state.productos.unshift({nombre:desc,precio});
      else state.productos=state.productos.map(p=>p.nombre.toLowerCase()===desc.toLowerCase()?({...p,precio}):p);
      guardarCatalogosLocal();

      if(state.companyKey){
        try{ await setDoc(doc(colProductos(),desc),{nombre:desc,precio}); showMsg("Producto guardado y sincronizado ‚úÖ"); }
        catch(err){ console.error(err); showMsg("No se pudo guardar en la nube. Qued√≥ local.", false); return; }
      }else{ showMsg("Producto guardado localmente (sin clave de sync).", true); }
    };
    function renderAdminProductos(){
      const cont=$('listaProductos'); cont.innerHTML='';
      if(state.productos.length===0){ cont.innerHTML='<div class="muted">No hay productos guardados.</div>'; return; }
      state.productos.forEach((p,i)=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div><b>${p.nombre}</b><br><small>${mxn.format(p.precio)}</small></div>
                       <button class="danger" onclick="eliminarProducto(${i})">Eliminar</button>`;
        cont.appendChild(row);
      });
    }
    window.eliminarProducto = async (i)=>{
      const nombre=state.productos[i].nombre;
      state.productos.splice(i,1); guardarCatalogosLocal();
      if(state.companyKey){ await deleteDoc(doc(colProductos(),nombre)).catch(()=>{}); }
      renderAdminProductos();
    };
    window.borrarTodosProductos = async ()=>{
      if(!confirm("¬øBorrar todos los productos?")) return;
      const arr=[...state.productos]; state.productos=[]; guardarCatalogosLocal();
      if(state.companyKey){ await Promise.all(arr.map(p=>deleteDoc(doc(colProductos(),p.nombre)).catch(()=>{}))); }
      renderAdminProductos();
    };

    // ------- √çtems y Totales -------
    window.addItem = ()=>{
      const idx=state.nota.items.length;
      state.nota.items.push({id:Date.now()+idx,descripcion:'',cantidad:1,precio:0});
      const row=document.createElement('div'); row.className='card item-card'; row.style.padding='10px'; row.style.margin='8px 0';
      row.innerHTML=`
        <div class="grid3">
          <div><label>Descripci√≥n</label><input id="item-desc-${idx}" placeholder="Descripci√≥n"></div>
          <div><label>Cantidad</label><input type="number" id="item-cant-${idx}" value="1" min="0"></div>
          <div><label>Precio</label><input type="number" id="item-precio-${idx}" value="0" min="0"></div>
        </div>
        <div class="row between" style="margin-top:8px">
          <div class="row" style="flex:1">
            <select class="selProducto" id="item-sel-${idx}" style="flex:1"></select>
            <button class="secondary no-print" style="white-space:nowrap" onclick="guardarProductoDesdeFila(${idx})">üíæ Guardar como producto</button>
          </div>
          <div class="row" style="gap:6px">
            <div class="right" style="min-width:140px"><b id="item-total-${idx}">$0</b></div>
            <button class="no-print" onclick="removeItem(${idx})">üóëÔ∏è</button>
          </div>
        </div>`;
      $('items').appendChild(row);
      const descEl=$('item-desc-'+idx), cantEl=$('item-cant-'+idx), precioEl=$('item-precio-'+idx), totalEl=$('item-total-'+idx);
      descEl.oninput=()=>{state.nota.items[idx].descripcion=descEl.value; calcFila(idx,totalEl,cantEl,precioEl);};
      cantEl.oninput=()=>{state.nota.items[idx].cantidad=Number(cantEl.value||0); calcFila(idx,totalEl,cantEl,precioEl);};
      precioEl.oninput=()=>{state.nota.items[idx].precio=Number(precioEl.value||0); calcFila(idx,totalEl,cantEl,precioEl);};
      refrescarSelectsProductos(); calc();
    };
    function calcFila(idx,totalEl,cantEl,precioEl){const cant=Number(cantEl.value||0),precio=Number(precioEl.value||0); totalEl.textContent=mxn.format(cant*precio); calc();}
    window.removeItem = (idx)=>{
      state.nota.items.splice(idx,1); $('items').innerHTML=''; const prev=[...state.nota.items]; state.nota.items=[];
      prev.forEach(()=>addItem()); prev.forEach((it,i)=>{ $('item-desc-'+i).value=it.descripcion; $('item-cant-'+i).value=it.cantidad; $('item-precio-'+i).value=it.precio; ['desc','cant','precio'].forEach(k=>$('item-'+k+'-'+i).dispatchEvent(new Event('input')));}); calc();
    };
    function calc(){const subtotal=(state.nota.items||[]).reduce((a,it)=>a+(Number(it.cantidad||0)*Number(it.precio||0)),0); const desc=subtotal*(Number($('descuento').value||0)/100); const total=Math.max(0,subtotal-desc); $('subtotal').textContent=mxn.format(subtotal); $('descMonto').textContent=mxn.format(desc); $('total').textContent=mxn.format(total);}

    // ------- Historial -------
    window.guardarHistorial = async ()=>{
      const snapshot = {
        folio: $('folio').textContent,
        fecha: new Date().toLocaleDateString("es-MX"),
        cliente: $('cliente').value || "‚Äî",
        direccion: $('direccion').value || "",
        items: state.nota.items.map(it=>({descripcion:it.descripcion,cantidad:Number(it.cantidad||0),precio:Number(it.precio||0)})),
        descuentoPorc: Number($('descuento').value||0),
        notas: $('notas').value || "",
        subtotal: $('subtotal').textContent,
        total: $('total').textContent
      };

      // Local
      const hist=JSON.parse(localStorage.getItem(LS.HIST)||"[]");
      hist.unshift({ ...snapshot });
      guardarHistorialLocal(hist);

      // Nube
      if(state.companyKey){
        try{ await addDoc(colHistorial(), { ...snapshot, ts: serverTimestamp() }); }
        catch(err){ console.error(err); showMsg("Nota guardada localmente, pero no se pudo subir a la nube.", false); }
      }

      let folioNum=Number(localStorage.getItem(LS.FOLIO)||1); folioNum++; localStorage.setItem(LS.FOLIO,folioNum);
      alert("Nota guardada ‚úÖ Nuevo folio: TMP-"+String(folioNum).padStart(4,"0"));
      location.reload();
    };

    function renderHistorial(){
      const term = ($('buscaHist')?.value || '').toLowerCase();
      const data = (state.histMerged.length? state.histMerged : state.histLocal).map((h,i)=>({
        ...h, _canUse: !!(h.items && h.items.length)
      }));
      const rows = data
        .filter(h => !term || (h.folio?.toLowerCase().includes(term) || (h.cliente||'').toLowerCase().includes(term)))
        .map(h => {
          const id = h._id || '';
          const localIdx = typeof h._localIndex==='number' ? h._localIndex : -1;
          return `<tr>
            <td>${h.fecha||'‚Äî'}</td>
            <td>${h.folio||'‚Äî'}</td>
            <td>${h.cliente||'‚Äî'}</td>
            <td>${h.total||'‚Äî'}</td>
            <td>${h.origen|| (id?'Nube':'Local')}</td>
            <td class="no-print">
              ${h._canUse ? (id
                ? `<button onclick="usarNotaNube('${id}')">Usar esta nota</button>`
                : `<button onclick="usarNotaLocal(${localIdx})">Usar esta nota</button>`) : ''
              }
              ${id?` <button class="danger" onclick="eliminarHistNube('${id}')">Borrar nube</button>`:''}
            </td>
          </tr>`;
        }).join('');
      $('tbodyHistorial').innerHTML = rows || `<tr><td colspan="6" class="muted">Sin registros.</td></tr>`;
    }

    window.usarNotaLocal = (idx)=>{
      if(idx<0) return;
      const h = state.histLocal[idx]; if(!h || !h.items) { alert("Este registro no tiene datos completos."); return; }
      cargarNotaEnFormulario(h);
    };
    window.usarNotaNube = async (id)=>{
      try{
        const snap = await getDoc(doc(colHistorial(), id));
        if(!snap.exists()){ alert("No se encontr√≥ la nota en la nube"); return; }
        const h = snap.data();
        if(!h.items){ alert("Este registro no tiene datos completos."); return; }
        cargarNotaEnFormulario(h);
      }catch(e){ console.error(e); alert("No se pudo cargar la nota de la nube"); }
    };
    function cargarNotaEnFormulario(h){
      $('cliente').value = h.cliente || '';
      $('direccion').value = h.direccion || '';
      $('descuento').value = h.descuentoPorc || 0;
      $('notas').value = h.notas || '';
      state.nota.items = []; $('items').innerHTML = '';
      (h.items||[]).forEach(it=>{
        addItem();
        const i = state.nota.items.length - 1;
        $('item-desc-'+i).value = it.descripcion || '';
        $('item-cant-'+i).value = it.cantidad || 0;
        $('item-precio-'+i).value = it.precio || 0;
        ['desc','cant','precio'].forEach(k => $('item-'+k+'-'+i).dispatchEvent(new Event('input')));
      });
      calc();
      alert("Nota cargada en el formulario ‚úÖ Puedes editar e imprimir, y al guardar se generar√° un nuevo folio.");
      window.scrollTo({top:0,behavior:'smooth'});
    }
    window.eliminarHistNube = async (id)=>{
      if(!state.companyKey) return;
      if(!confirm("¬øBorrar este registro de la nube?")) return;
      try{ await deleteDoc(doc(colHistorial(), id)); }catch{}
    };
    window.borrarHistorialLocal = ()=>{
      if(!confirm("¬øBorrar historial LOCAL del dispositivo?")) return;
      guardarHistorialLocal([]); renderHistorial();
    };

    // ------- Exportar/Importar cat√°logos -------
    window.toggleAdmin = id => { const el=$(id); el.style.display=(el.style.display==='block')?'none':'block'; if(id==='adminClientes') renderAdminClientes(); if(id==='adminProductos') renderAdminProductos(); };
    window.toggleHistorial = ()=>{ const el=$('historialCard'); el.style.display=(el.style.display==='block')?'none':'block'; renderHistorial(); };
    window.exportarCatalogo = tipo => { const data=tipo==='clientes'?state.clientes:state.productos; download(`${tipo}-tmp.json`,JSON.stringify(data,null,2)); };
    window.importarCatalogo = (e,tipo)=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader(); reader.onload=async ()=>{
        try{ const arr=JSON.parse(reader.result||"[]"); if(!Array.isArray(arr)) throw new Error("Formato inv√°lido");
          if(tipo==='clientes'){ state.clientes=arr; if(state.companyKey){ await Promise.all(arr.map(c=>setDoc(doc(colClientes(),c.nombre),c))); } }
          else { state.productos=arr; if(state.companyKey){ await Promise.all(arr.map(p=>setDoc(doc(colProductos(),p.nombre),p))); } }
          guardarCatalogosLocal(); (tipo==='clientes'?renderAdminClientes:renderAdminProductos)(); showMsg("Cat√°logo importado ‚úÖ", true);
        }catch(err){ showMsg("No se pudo importar: "+err.message, false); }
        e.target.value='';
      }; reader.readAsText(file);
    };

    // ------- PDF nombrado + Encabezado/Pie -------
    function nombrePDF(){
      const folio = ($('folio')?.textContent || 'FOLIO').trim().replace(/\s+/g,'');
      const clienteRaw = ($('cliente')?.value || 'Cliente').trim();
      const cliente = clienteRaw.normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^\p{L}\p{N}\-_ ]/gu,'').slice(0,40).trim().replace(/\s+/g,'_');
      return `${folio}_${cliente || 'Cliente'}.pdf`;
    }
    function prepararBarrasImpresion(){
      const build = ()=>{
        const folio = ($('folio')?.textContent||'').trim();
        const fecha = ($('fecha')?.textContent||'').trim();
        const cliente = ($('cliente')?.value||'').trim();
        const total = ($('total')?.textContent||'').trim();
        $('printHeader').textContent = `Folio: ${folio}  |  Fecha: ${fecha}  |  Cliente: ${cliente}`;
        $('printFooter').textContent = `Total: ${total}  ‚Ä¢  TMP Regenerative`;
      };
      window.onbeforeprint = build;
    }
    window.exportarPDF = ()=>{
      const prevTitle = document.title;
      document.title = nombrePDF();
      const restore = () => setTimeout(()=>{ document.title = prevTitle; }, 500);
      const oldAfter = window.onafterprint;
      window.onafterprint = () => { restore(); window.onafterprint = oldAfter; };
      window.print();
      setTimeout(restore, 3000);
    };

    // ------- Probar sync -------
    window.probarSync = async ()=>{
      clearMsg();
      if(!state.companyKey){ showMsg("Primero activa sync con una clave.", false); return; }
      try{
        const test = { cliente:"SYNC_TEST", fecha:new Date().toLocaleString("es-MX"), folio:"TMP-TEST", items:[{descripcion:"Ping",cantidad:1,precio:0}], total:"$0", ts: serverTimestamp() };
        await addDoc(colHistorial(), test);
        showMsg("Escritura OK. Esperando confirmaci√≥n de lectura‚Ä¶", true);
        setTimeout(()=>{
          const found = (state.histMerged||[]).some(h=>h.cliente==="SYNC_TEST" || h.folio==="TMP-TEST");
          if(found) showMsg("Lectura OK. ¬°Sync funcionando! ‚úÖ", true);
          else showMsg("Se escribi√≥, pero no se ley√≥ a√∫n. Verifica reglas/conexi√≥n.", false);
        }, 2000);
      }catch(err){
        console.error(err);
        showMsg("Fall√≥ la escritura en Firestore. Revisa Rules y Authentication.", false);
      }
    };
  </script>
</body>
</html>
