<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Notas de Remisi√≥n TMP Regenerative</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#00b5ad">
<link rel="icon" href="icons/icon-192.png">
<style>
  :root{--c:#00b5ad}
  body{font-family:system-ui,sans-serif;background:#f8fafc;color:#222;margin:0}
  h1{text-align:center;color:var(--c);margin:16px 0}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:16px;max-width:1000px;margin:20px auto}
  .row{display:flex;gap:8px;align-items:center}
  .between{justify-content:space-between}
  input,select,textarea{width:100%;padding:8px;border:1px solid #cfd6de;border-radius:8px;font-size:14px}
  button{background:var(--c);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
  button.secondary{background:#e6f7f6;color:#0d6662}
  button.danger{background:#e74c3c}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px}
  .line{border-top:1px solid #e5e7eb;margin:12px 0}
  .right{text-align:right}
  .muted{font-size:12px;color:#6b7785}
  #msg{display:none;margin-top:8px;border-radius:8px;padding:8px}
  .ok{background:#e7fbf9;color:#0e7a72;border:1px solid #b7efea}
  .err{background:#fdecec;color:#8a1e1e;border:1px solid #f5bcbc}
  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px auto;max-width:1000px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eef2f6;text-align:left;font-size:14px}
  th{background:#f3f6f9}
  @media print{ .no-print{display:none!important} .card{box-shadow:none} }
</style>
</head>
<body>
  <h1>Notas de Remisi√≥n TMP Regenerative</h1>

  <!-- Sincronizaci√≥n -->
  <div class="card no-print">
    <h3>üîÑ Sincronizaci√≥n autom√°tica (Firebase)</h3>
    <div class="grid2">
      <div>
        <label>Clave de empresa (ej. TMP-CUU)</label>
        <input id="companyKey" placeholder="Ej: TMP-CUU">
      </div>
      <div class="row" style="align-items:end">
        <button class="secondary" id="btnGuardarClave">Guardar clave</button>
        <span id="syncStatus" class="muted">Estado: sin sincronizar</span>
      </div>
    </div>
    <div id="msg"></div>
    <div class="muted" style="margin-top:6px">Con clave guardada: sincroniza <b>clientes</b>, <b>productos</b> y <b>historial</b> en autom√°tico.</div>
  </div>

  <!-- Acciones -->
  <div class="actions no-print">
    <button id="btnGuardarNota">üíæ Guardar / Nuevo folio</button>
    <button class="secondary" id="btnVerHist">üìú Ver historial</button>
    <button class="secondary" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
  </div>

  <!-- Encabezado -->
  <div class="card">
    <div class="between row">
      <div>
        <h3 style="margin:0">Gilberto Morales Vargas</h3>
        <p style="margin:0">Chihuahua, M√©xico</p>
        <p style="margin:0">RFC: <b>MOVG850703SL4</b> ¬∑ Tel: <b>614 176 5850</b></p>
        <p style="margin:0">Email: <a href="mailto:gmorales.tmp@gmail.com">gmorales.tmp@gmail.com</a></p>
      </div>
      <div class="right">
        <div style="font-weight:700">Nota de remisi√≥n</div>
        <div id="folio">TMP-CHIH-0001</div>
        <div id="fecha" class="muted"></div>
      </div>
    </div>

    <div class="line"></div>

    <!-- Cliente -->
    <h3>Cliente</h3>
    <div class="grid2">
      <div>
        <label>Seleccionar cliente guardado</label>
        <select id="selCliente"></select>
      </div>
      <div class="row" style="align-items:end">
        <button class="secondary" id="btnGuardarCliente">üìá Guardar cliente actual</button>
        <button class="secondary" id="btnAdminClientes">‚öôÔ∏è Ver clientes</button>
      </div>
      <div>
        <label>Nombre</label>
        <input id="cliente" placeholder="Nombre del cliente">
      </div>
      <div>
        <label>Direcci√≥n</label>
        <input id="direccion" placeholder="Direcci√≥n del cliente">
      </div>
    </div>

    <!-- Admin clientes -->
    <div id="adminClientes" class="no-print" style="display:none;margin-top:8px">
      <div class="line"></div>
      <h4>Clientes guardados</h4>
      <div id="listaClientes"></div>
    </div>

    <div class="line"></div>

    <!-- Conceptos -->
    <div class="between row">
      <h3 style="margin:0">Conceptos</h3>
      <button id="btnAddConcepto" type="button" onclick="addItem()">‚ûï Agregar concepto</button>
    </div>

    <div id="items"></div>

    <!-- Totales -->
    <div class="line"></div>
    <div class="grid2">
      <div>
        <label>Descuento (%)</label>
        <input type="number" id="descuento" value="0" min="0" max="100" step="0.5" oninput="calc()">
      </div>
      <div class="right">
        <p>Subtotal (IVA incluido): <b id="subtotal">$0</b></p>
        <p>Descuento: -<span id="descMonto">$0</span></p>
        <p><b>Total: <span id="total">$0</span></b></p>
      </div>
    </div>

    <div class="line"></div>
    <textarea id="notas" rows="3" placeholder="Notas adicionales"></textarea>
  </div>

  <!-- Historial -->
  <div id="histCard" class="card no-print" style="display:none">
    <div class="between row">
      <h3 style="margin:0">Historial de notas</h3>
      <input id="buscarHist" placeholder="Buscar por folio o cliente" style="max-width:260px">
    </div>
    <div class="line"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Fecha</th><th>Folio</th><th>Cliente</th><th>Total</th><th>Origen</th><th>Acciones</th></tr></thead>
        <tbody id="tbodyHist"></tbody>
      </table>
    </div>
  </div>

<script type="module">
/* ===== Utilidades y estado ===== */
const mxn = new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"});
const $ = id => document.getElementById(id);
const LS = { CLIENTES:'tmp_clientes', PRODUCTOS:'tmp_productos', FOLIO:'tmp_folio', COMPANY:'tmp_company', HIST:'tmp_hist' };
const state = { nota:{items:[]}, clientes:[], productos:[], histLocal:[], histMerged:[], companyKey: localStorage.getItem(LS.COMPANY)||"" };

/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, deleteDoc, addDoc, getDoc, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVBZPlMSMCnypOjexBHLLd-w7Xmd1ndn0",
  authDomain: "notas-tmp.firebaseapp.com",
  projectId: "notas-tmp",
  storageBucket: "notas-tmp.firebasestorage.app",
  messagingSenderId: "640595451791",
  appId: "1:640595451791:web:dd150bca4cfb8cbc6735fa",
  measurementId: "G-JZZPDPNE03"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const colClientes = ()=>collection(db,"companies",state.companyKey,"clientes");
const colProductos= ()=>collection(db,"companies",state.companyKey,"productos");
const colHistorial= ()=>collection(db,"companies",state.companyKey,"historial");
let unsubC=null,unsubP=null,unsubH=null;

async function ensureAuth(){
  try{ await signInAnonymously(auth); $('syncStatus').textContent=`Estado: sincronizado (${state.companyKey})`; }
  catch(e){ $('syncStatus').textContent="Estado: sin sincronizar"; }
}
function attachCloudListeners(){
  if(!state.companyKey) return;
  unsubC&&unsubC(); unsubP&&unsubP(); unsubH&&unsubH();
  unsubC=onSnapshot(query(colClientes(),orderBy("nombre")),s=>{ const arr=[]; s.forEach(d=>arr.push(d.data())); if(arr.length){ state.clientes=arr; saveLocal(); renderClientes(); }});
  unsubP=onSnapshot(query(colProductos(),orderBy("nombre")),s=>{ const arr=[]; s.forEach(d=>arr.push(d.data())); if(arr.length){ state.productos=arr; saveLocal(); refreshProductSelects(); }});
  unsubH=onSnapshot(query(colHistorial(),orderBy("ts","desc"),limit(200)),s=>{
    const cloud=[]; s.forEach(d=>cloud.push({...d.data(), _id:d.id, origen:"Nube"}));
    state.histMerged = mergeHist(cloud, state.histLocal);
    renderHistTable(state.histMerged);
  });
}
async function cloudUpsertCliente(c){ if(state.companyKey) try{ await setDoc(doc(colClientes(),c.nombre),c);}catch{} }
async function cloudDeleteCliente(n){ if(state.companyKey) try{ await deleteDoc(doc(colClientes(),n));}catch{} }
async function cloudUpsertProducto(p){ if(state.companyKey) try{ await setDoc(doc(colProductos(),p.nombre),p);}catch{} }
async function cloudAddHist(h){ if(state.companyKey) try{ await addDoc(colHistorial(),{...h, ts:serverTimestamp()});}catch{} }

/* ===== Local ===== */
function loadLocal(){
  try{state.clientes=JSON.parse(localStorage.getItem(LS.CLIENTES)||"[]")}catch{}
  try{state.productos=JSON.parse(localStorage.getItem(LS.PRODUCTOS)||"[]")}catch{}
  try{state.histLocal=JSON.parse(localStorage.getItem(LS.HIST)||"[]")}catch{}
}
function saveLocal(){
  localStorage.setItem(LS.CLIENTES,JSON.stringify(state.clientes));
  localStorage.setItem(LS.PRODUCTOS,JSON.stringify(state.productos));
}
function saveHistLocal(arr){ state.histLocal=arr; localStorage.setItem(LS.HIST,JSON.stringify(arr)); }

/* ===== Mensajes ===== */
function msg(txt, ok=true){ const m=$('msg'); m.style.display='block'; m.className= ok?'ok':'err'; m.textContent=txt; if(ok) setTimeout(()=>m.style.display='none',4000); }

/* ===== UI Inicial ===== */
function currentFolioPrefix(){ return (state.companyKey || 'TMP-CHIH') + '-'; }
function initUI(){
  $('fecha').textContent=new Date().toLocaleDateString('es-MX');
  const folioNum=Number(localStorage.getItem(LS.FOLIO)||1);
  $('folio').textContent=currentFolioPrefix()+String(folioNum).padStart(4,'0');

  $('companyKey').value=state.companyKey;
  renderClientes(); if(state.nota.items.length===0) addItem(); calc();

  $('btnGuardarClave').onclick=async()=>{
    const key=($('companyKey').value||"").trim();
    state.companyKey=key; localStorage.setItem(LS.COMPANY,key);
    // refrescar folio mostrado con la nueva clave
    const num=Number(localStorage.getItem(LS.FOLIO)||1);
    $('folio').textContent=currentFolioPrefix()+String(num).padStart(4,'0');

    if(!key){ $('syncStatus').textContent="Estado: sin sincronizar"; msg("Clave eliminada. Solo guardado local.",true); return; }
    await ensureAuth(); attachCloudListeners(); msg("Sincronizaci√≥n autom√°tica activada ‚úÖ");
  };

  $('btnGuardarCliente').onclick=guardarCliente;
  $('btnAdminClientes').onclick=()=>{ const p=$('adminClientes'); p.style.display=p.style.display==='none'?'block':'none'; renderClientesList(); };
  $('selCliente').onchange=()=>{ const v=$('selCliente').value; if(v==="") return; const c=state.clientes[Number(v)]; $('cliente').value=c?.nombre||''; $('direccion').value=c?.direccion||''; };

  $('btnGuardarNota').onclick=guardarNota;
  $('btnVerHist').onclick=()=>{ const c=$('histCard'); c.style.display=c.style.display==='none'?'block':'none'; renderHistTable(state.histMerged.length?state.histMerged:mergeHist(null,state.histLocal)); };
  $('buscarHist').oninput=()=>renderHistTable(state.histMerged.length?state.histMerged:mergeHist(null,state.histLocal));
}

/* ===== Clientes ===== */
function renderClientes(){
  const sel=$('selCliente');
  sel.innerHTML='<option value="">‚Äî Elegir cliente ‚Äî</option>'+state.clientes.map((c,i)=>`<option value="${i}">${c.nombre}</option>`).join('');
}
function renderClientesList(){
  const cont=$('listaClientes'); cont.innerHTML='';
  if(state.clientes.length===0){ cont.innerHTML='<div class="muted">No hay clientes guardados.</div>'; return; }
  state.clientes.forEach((c,i)=>{
    const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
    row.innerHTML=`<div><b>${c.nombre}</b><br><small>${c.direccion||'‚Äî'}</small></div><button class="danger">Eliminar</button>`;
    row.querySelector('button').onclick=async()=>{ const n=state.clientes[i].nombre; state.clientes.splice(i,1); saveLocal(); renderClientes(); renderClientesList(); await cloudDeleteCliente(n); };
    cont.appendChild(row);
  });
}
async function guardarCliente(){
  const nombre=($('cliente').value||'').trim(); const direccion=($('direccion').value||'').trim();
  if(!nombre){ msg("Escribe el nombre del cliente",false); return; }
  const ix=state.clientes.findIndex(c=>c.nombre.toLowerCase()===nombre.toLowerCase());
  if(ix<0) state.clientes.unshift({nombre,direccion}); else state.clientes[ix]={nombre,direccion};
  saveLocal(); renderClientes(); renderClientesList(); await cloudUpsertCliente({nombre,direccion}); msg("Cliente guardado ‚úÖ");
}

/* ===== Productos ===== */
function refreshProductSelects(){
  document.querySelectorAll('.selProducto').forEach((el,idx)=>{
    const d=$('desc-'+idx), p=$('precio-'+idx);
    el.innerHTML='<option value="">‚Äî Producto ‚Äî</option>'+state.productos.map((pr,i)=>`<option value="${i}">${pr.nombre} (${mxn.format(pr.precio)})</option>`).join('');
    el.onchange=()=>{ const v=el.value; if(v==="") return; const pr=state.productos[Number(v)];
      d.value=pr.nombre; p.value=pr.precio; state.nota.items[idx].descripcion=pr.nombre; state.nota.items[idx].precio=Number(pr.precio||0); calc(); };
  });
}
async function guardarProductoDesdeFila(idx){
  const nombre=($('desc-'+idx).value||'').trim(); const precio=Number($('precio-'+idx).value||0);
  if(!nombre){ msg("Escribe la descripci√≥n del producto",false); return; }
  const ix=state.productos.findIndex(p=>p.nombre.toLowerCase()===nombre.toLowerCase());
  if(ix<0) state.productos.unshift({nombre,precio}); else state.productos[ix]={nombre,precio};
  saveLocal(); refreshProductSelects(); await cloudUpsertProducto({nombre,precio}); msg("Producto guardado ‚úÖ");
}
window.guardarProductoDesdeFila = guardarProductoDesdeFila; // <<<<<< EXPUESTO PARA EVITAR EL ERROR

/* ===== √çtems y totales ===== */
function addItem(){
  const idx=state.nota.items.length; state.nota.items.push({descripcion:'',cantidad:1,precio:0});
  const row=document.createElement('div'); row.className='card'; row.style.padding='10px'; row.style.margin='8px 0';
  row.innerHTML=`
    <div class="grid3">
      <div><label>Descripci√≥n</label><input id="desc-${idx}" placeholder="Descripci√≥n"></div>
      <div><label>Cantidad</label><input type="number" id="cant-${idx}" value="1" min="1"></div>
      <div><label>Precio</label><input type="number" id="precio-${idx}" value="0" min="0"></div>
    </div>
    <div class="row" style="margin-top:6px;justify-content:space-between">
      <div class="row" style="flex:1">
        <select class="selProducto" id="sel-${idx}" style="flex:1"></select>
        <button class="secondary" onclick="guardarProductoDesdeFila(${idx})">üíæ Guardar como producto</button>
      </div>
      <div class="row">
        <div class="right" style="min-width:140px"><b id="total-${idx}">$0</b></div>
        <button class="danger" onclick="removeItem(${idx})">üóëÔ∏è</button>
      </div>
    </div>`;
  $('items').appendChild(row);
  $('desc-'+idx).oninput=()=>{state.nota.items[idx].descripcion=$('desc-'+idx).value; calc();}
  $('cant-'+idx).oninput=()=>{state.nota.items[idx].cantidad=Number($('cant-'+idx).value||0); calc();}
  $('precio-'+idx).oninput=()=>{state.nota.items[idx].precio=Number($('precio-'+idx).value||0); calc();}
  refreshProductSelects(); calc();
}
window.addItem=addItem;

function removeItem(i){
  state.nota.items.splice(i,1);
  const backup=[...state.nota.items]; $('items').innerHTML=''; state.nota.items=[];
  backup.forEach(()=>addItem()); backup.forEach((it,ix)=>{ $('desc-'+ix).value=it.descripcion||''; $('cant-'+ix).value=it.cantidad||1; $('precio-'+ix).value=it.precio||0; state.nota.items[ix]=it; });
  calc();
}
function calc(){
  let subtotal=0; state.nota.items.forEach((it,i)=>{ const t=Number(it.cantidad||0)*Number(it.precio||0); subtotal+=t; const el=$('total-'+i); if(el) el.textContent=mxn.format(t); });
  const desc=subtotal*(Number($('descuento').value||0)/100); const total=Math.max(0,subtotal-desc);
  $('subtotal').textContent=mxn.format(subtotal); $('descMonto').textContent=mxn.format(desc); $('total').textContent=mxn.format(total);
}

/* ===== Historial ===== */
function mergeHist(cloud, local){
  const L = (local||[]).map((h,i)=>({...h,_localIndex:i,origen:h.origen||"Local"}));
  const C = (cloud||[]);
  return [...C, ...L]; // nube primero
}
function renderHistTable(data){
  const term = ($('buscarHist')?.value||'').toLowerCase();
  const rows = (data || state.histLocal)
    .filter(h => !term || (h.folio||'').toLowerCase().includes(term) || (h.cliente||'').toLowerCase().includes(term))
    .map(h=>{
      const useBtn = h._id
        ? `<button class="secondary" onclick="usarNotaNube('${h._id}')">Usar esta nota</button>`
        : (typeof h._localIndex==='number' ? `<button class="secondary" onclick="usarNotaLocal(${h._localIndex})">Usar esta nota</button>` : '');
      return `<tr>
        <td>${h.fecha||'‚Äî'}</td>
        <td>${h.folio||'‚Äî'}</td>
        <td>${h.cliente||'‚Äî'}</td>
        <td>${h.total||'‚Äî'}</td>
        <td>${h.origen||'‚Äî'}</td>
        <td>${useBtn}</td>
      </tr>`;
    })
    .join('');
  $('tbodyHist').innerHTML = rows || `<tr><td colspan="6" class="muted">Sin registros.</td></tr>`;
}
function cargarNotaEnFormulario(h){
  $('cliente').value = h.cliente || '';
  $('direccion').value = h.direccion || '';
  $('descuento').value = h.descuentoPorc || 0;
  $('notas').value = h.notas || '';
  state.nota.items = []; $('items').innerHTML = '';
  (h.items||[]).forEach(it=>{
    addItem();
    const i = state.nota.items.length - 1;
    $('desc-'+i).value = it.descripcion || '';
    $('cant-'+i).value = it.cantidad || 0;
    $('precio-'+i).value = it.precio || 0;
    state.nota.items[i] = {descripcion:it.descripcion, cantidad:it.cantidad, precio:it.precio};
  });
  calc();
  alert("Nota cargada en el formulario ‚úÖ Ed√≠tala y guarda para generar un nuevo folio.");
  window.scrollTo({top:0,behavior:'smooth'});
}
window.usarNotaLocal = (i)=>{
  if(i<0) return; const h = state.histLocal[i]; if(!h) return; cargarNotaEnFormulario(h);
};
window.usarNotaNube = async (id)=>{
  try{ const snap = await getDoc(doc(colHistorial(), id)); if(!snap.exists()) return; const h = snap.data(); cargarNotaEnFormulario(h); }
  catch(e){ alert("No se pudo cargar la nota de la nube"); }
};

async function guardarNota(){
  const snapshot = {
    folio: $('folio').textContent,
    fecha: new Date().toLocaleDateString('es-MX'),
    cliente: $('cliente').value || '‚Äî',
    direccion: $('direccion').value || '',
    items: state.nota.items.map(it=>({descripcion:it.descripcion,cantidad:Number(it.cantidad||0),precio:Number(it.precio||0)})),
    descuentoPorc: Number($('descuento').value||0),
    notas: $('notas').value || '',
    subtotal: $('subtotal').textContent,
    total: $('total').textContent,
    origen: 'Local'
  };
  const hist = JSON.parse(localStorage.getItem(LS.HIST)||"[]"); hist.unshift(snapshot); saveHistLocal(hist);
  await cloudAddHist(snapshot);

  let folioNum=Number(localStorage.getItem(LS.FOLIO)||1); folioNum++; localStorage.setItem(LS.FOLIO,folioNum);
  alert("Nota guardada ‚úÖ Nuevo folio: "+currentFolioPrefix()+String(folioNum).padStart(4,'0'));
  location.reload();
}

/* ===== Bootstrap ===== */
window.addEventListener('error', e=>msg(e.message||'Error',false));
window.addEventListener('unhandledrejection', e=>msg((e.reason&&e.reason.message)||'Error',false));

(function start(){
  try{
    // Local
    try{state.clientes=JSON.parse(localStorage.getItem(LS.CLIENTES)||"[]")}catch{}
    try{state.productos=JSON.parse(localStorage.getItem(LS.PRODUCTOS)||"[]")}catch{}
    try{state.histLocal=JSON.parse(localStorage.getItem(LS.HIST)||"[]")}catch{}

    // UI
    initUI();
    renderHistTable(state.histLocal);

    // Sync si hay clave
    if(state.companyKey){ ensureAuth().then(attachCloudListeners); }
  }catch(e){ console.error(e); msg("Error al iniciar: "+e.message,false); }
})();
</script>
</body>
</html>
